<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ÿ™ÿ£ŸÉŸäÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ≥ÿ®ŸàŸÜÿ¨Ÿä ŸÉÿ±Ÿàÿ®</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
      background-size: 400% 400%;
      animation: gradientText 3s ease infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255,255,255,0.5);
      margin-bottom: 15px;
      transform: perspective(1000px) rotateX(15deg);
    }

    @keyframes gradientText {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .camera-container {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 30px;
    }

    .video-wrapper {
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    #video {
      width: 100%;
      max-width: 600px;
      height: auto;
      display: block;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .scanner-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff88, transparent);
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      0% { transform: translateY(0); }
      100% { transform: translateY(300px); }
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .btn.flash-on {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    }

    .btn.flash-off {
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
    }

    .btn.danger {
      background: linear-gradient(135deg, #ff4757, #c44569);
    }

    .btn.info {
      background: linear-gradient(135deg, #3742fa, #2f3542);
    }

    .main-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 1200px;
      margin-top: 30px;
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .stats-card h3 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-card .icon {
      font-size: 1.5rem;
    }

    .barcode-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 4px solid #00ff88;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }

    .barcode-item.repeated {
      border-left-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    .db-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .db-stat-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .db-stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #00ff88;
    }

    .db-stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 5px;
    }

    .status-message {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 1000;
      max-width: 300px;
    }

    .message {
      background: rgba(0, 0, 0, 0.9);
      color: #00ff88;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: translateX(100%);
      animation: slideIn 0.3s ease forwards;
    }

    .message.error {
      color: #ff6b6b;
    }

    .message.warning {
      color: #ffa726;
    }

    @keyframes slideIn {
      to { transform: translateX(0); }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #ffffff;
      font-weight: 600;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .management-section {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 10% auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
    }

    .close {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: white;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      
      .camera-container {
        margin: 0 10px;
      }
      
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 200px;
      }

      .main-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ÿ™ÿ£ŸÉŸäÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ≥ÿ®ŸàŸÜÿ¨Ÿä ŸÉÿ±Ÿàÿ®</h1>
    <p>ŸÅŸÇÿ∑</p>
  </div>

  <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ -->
  <div style="
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
    text-align: center;
  ">
    <a href="/" style="
      display: inline-block;
      margin: 8px 12px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
      üè† ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
    </a>
    
    <a href="/telegram-monitor" style="
      display: inline-block;
      margin: 8px 12px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
      ü§ñ ŸÖÿ±ÿßŸÇÿ® ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ
    </a>
    
    <a href="/stats" style="
      display: inline-block;
      margin: 8px 12px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
      üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
    </a>
  </div>

  <div class="camera-container">
    <div class="video-wrapper">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
      <div class="scanner-line"></div>
    </div>
    
    <div class="controls">
      <button id="flash-toggle" class="btn flash-off">üî¶ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸÑÿßÿ¥</button>
      <button id="camera-switch" class="btn">üîÑ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß</button>
      <button id="restart-app" class="btn info">üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ</button>
    </div>
  </div>

  <div class="main-container">
    <div class="stats-card">
      <h3>
        <span class="icon">‚úÖ</span>
        ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
      </h3>
      <div id="new-barcodes-list">
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
        </div>
      </div>
    </div>
    
    <div class="stats-card">
      <h3>
        <span class="icon">‚ö†Ô∏è</span>
        ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
      </h3>
      <div id="repeated-barcodes-list">
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
        </div>
      </div>
    </div>

    <div class="stats-card">
      <h3>
        <span class="icon">üìä</span>
        ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      </h3>
      <div id="database-stats">
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
        </div>
      </div>
      
      <div class="management-section">
        <button id="refresh-stats" class="btn info">üîÑ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</button>
        <button id="view-detailed-stats" class="btn info">üìà ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©</button>
      </div>
    </div>

    <div class="stats-card">
      <h3>
        <span class="icon">üìà</span>
        ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
      </h3>
      <div id="period-stats">
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
        </div>
      </div>
    </div>
  </div>

  <div id="status-messages" class="status-message"></div>

  <!-- Modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ÿßŸÑÿ¨ÿØŸäÿØ -->
  <div id="duplicate-image-modal" class="modal" style="display: none;">
    <div class="modal-content" style="
      max-width: 600px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      border: 3px solid #fff;
      box-shadow: 0 20px 60px rgba(255,107,107,0.4);
      animation: modalBounce 0.3s ease-out;
    ">
      <span class="duplicate-close" style="
        color: #fff;
        float: left;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">&times;</span>
      
      <div style="text-align: center; padding: 10px 0;">
        <h2 style="
          color: white;
          margin-bottom: 20px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
          font-size: 1.8rem;
          animation: pulse 2s infinite;
        ">‚ö†Ô∏è ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ±!</h2>
        
        <div style="
          background: rgba(255,255,255,0.1);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          backdrop-filter: blur(10px);
        ">
          <div style="
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
          ">
            ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ: <span id="duplicate-barcode" style="color: #ffeb3b;">-</span>
          </div>
          
          <div id="duplicate-details" style="
            color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
            font-size: 1rem;
          ">
            ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÜ ŸÇÿ®ŸÑ
          </div>
          
          <div id="duplicate-image-container" style="
            min-height: 200px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <div class="loading">
              <div class="spinner"></div>
              ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©...
            </div>
          </div>
        </div>
        
        <button id="close-duplicate-modal" style="
          background: linear-gradient(135deg, #4ecdc4, #44a08d);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 25px;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
           onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
          üîÑ ŸÖÿ≥ÿ≠ ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¢ÿÆÿ±
        </button>
      </div>
    </div>
  </div>

  <!-- ŸÖÿ§ÿ¥ÿ± ÿ≠ÿßŸÑÿ© ÿßŸÑÿ∑ÿßÿ®Ÿàÿ± -->
  <div id="telegram-queue-indicator" style="
    position: fixed;
    top: 100px;
    right: 30px;
    z-index: 1500;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    min-width: 200px;
    display: none;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
  ">
    <div style="font-weight: bold; margin-bottom: 10px; color: #4ecdc4;">üì§ ÿ∑ÿßÿ®Ÿàÿ± ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ</div>
    <div id="queue-stats">
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span>ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±:</span>
        <span id="queue-count" style="color: #00ff88;">0</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©:</span>
        <span id="queue-status" style="color: #ffa726;">ŸÖÿ™ŸàŸÇŸÅ</span>
      </div>
      <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 10px;">
        <div id="queue-progress" style="height: 100%; background: linear-gradient(90deg, #4ecdc4, #00ff88); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
      </div>
    </div>
  </div>

  <!-- ŸÖÿ§ÿ¥ÿ± ÿ£ÿØÿßÿ° ÿßŸÑŸÜÿ∏ÿßŸÖ -->
  <div id="performance-indicator" class="fps-indicator" style="display: none;">
    <div id="fps-display">FPS: --</div>
    <div style="font-size: 0.7rem; opacity: 0.8;">‚ö° ŸÖÿ™ÿ∑Ÿàÿ± v2.0</div>
  </div>

  <style>
  @keyframes modalBounce {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± */
  .duplicate-close {
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }
  
  .duplicate-close:hover {
    color: #ffeb3b !important;
    text-shadow: 0 0 10px rgba(255, 235, 59, 0.8);
  }
  
  #telegram-queue-indicator {
    animation: slideInFromRight 0.5s ease-out;
  }
  
  @keyframes slideInFromRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ£ÿØÿßÿ° ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ */
  #overlay {
    will-change: transform;
    backface-visibility: hidden;
    perspective: 1000px;
  }
  
  #video {
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  /* ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ£ÿØÿßÿ° */
  .fps-indicator {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.8);
    color: #00ff88;
    padding: 5px 10px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    z-index: 1000;
    border: 1px solid rgba(0, 255, 136, 0.3);
  }
  </style>

  <!-- ŸÖŸàÿØÿßŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ© -->
  <div id="stats-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>üìä ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©</h2>
      <div id="detailed-stats-content">
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©...
        </div>
      </div>
    </div>
  </div>

  <!-- ŸÖŸàÿØÿßŸÑ ÿ™ÿ£ŸÉŸäÿØ ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ -->
  <div id="reset-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ÿ™ÿ£ŸÉŸäÿØ ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h2>
      <p>‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿ≥Ÿäÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ŸÜŸáÿßÿ¶Ÿä!</p>
      <br>
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button id="confirm-reset" class="btn danger">ŸÜÿπŸÖÿå ÿßÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ¥Ÿäÿ°</button>
        <button id="cancel-reset" class="btn">ÿ•ŸÑÿ∫ÿßÿ°</button>
      </div>
    </div>
  </div>

  <!-- ÿµŸàÿ™ ÿßŸÑÿ™ŸÜÿ®ŸäŸá -->
  <audio id="beep-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp3a1VEhFOre7UjGMSENb6" type="audio/wav">
  </audio>

  <!-- ŸÖŸÉÿ™ÿ®ÿ© jsQR ŸÑŸÑŸÄ QR Codes -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  
  <!-- ŸÖŸÉÿ™ÿ®ÿ© QuaggaJS ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑÿπÿßÿØŸä -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  
  <!-- ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜ -->
  <script src="/static/duplicate-image.js"></script>

  <script>
    // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ
    const botToken = "7668051564:AAFdFqSd0CKrlSOyPKyFwf-xHi791lcsC_U";
    const chatId = -1002439956600; console.log("?? ??????? ????????? ????? - Token:", !!botToken, "ChatId:", !!chatId);
    
    // ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const context = overlay.getContext("2d");
    const beepSound = document.getElementById("beep-sound");
  const flashToggle = document.getElementById("flash-toggle");
    const cameraSwitch = document.getElementById("camera-switch");
    const statusMessages = document.getElementById("status-messages");
    const newBarcodesList = document.getElementById("new-barcodes-list");
    const repeatedBarcodesList = document.getElementById("repeated-barcodes-list");
    const databaseStats = document.getElementById("database-stats");
    const periodStats = document.getElementById("period-stats");
    const refreshStatsBtn = document.getElementById("refresh-stats");
    const viewDetailedStatsBtn = document.getElementById("view-detailed-stats");
    const statsModal = document.getElementById("stats-modal");
    const detailedStatsContent = document.getElementById("detailed-stats-content");
    const restartAppBtn = document.getElementById("restart-app");
    const closeModal = document.querySelector(".close");

    // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    let currentStream = null;
    let currentTrack = null;
  let flashEnabled = false;
    let isScanning = false;
    let cameras = [];
    let currentCameraIndex = 0;

    // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
  let barcodeDatabase = new Set();
  let barcodeTimes = {};
  let repeatedBarcodes = new Set();
    let newBarcodes = [];

    // ÿ•ÿµŸÑÿßÿ≠ ŸÅŸàÿ±Ÿä ŸÑŸÖÿ¥ŸÉŸÑÿ© ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
    setTimeout(() => {
      console.log("üîß ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
      
      const periodStatsElement = document.getElementById("period-stats");
      if (!periodStatsElement) {
        console.error("‚ùå ÿπŸÜÿµÿ± period-stats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");
        return;
      }
      
      // ÿØÿßŸÑÿ© ÿ•ÿµŸÑÿßÿ≠ ÿ®ÿØŸäŸÑÿ©
      async function fixPeriodStatsDisplay() {
        try {
          periodStatsElement.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...
            </div>
          `;
          
          const response = await fetch('/api/detailed-stats');
          if (!response.ok) {
            throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ: ${response.status}`);
          }
          
          const data = await response.json();
          console.log("üìä ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:", data);
          
          // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
          const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
          const thisMonth = data.daily_stats.filter(day => {
            const dayDate = new Date(day.date);
            const thisMonthStart = new Date();
            thisMonthStart.setDate(1);
            return dayDate >= thisMonthStart;
          }).reduce((sum, day) => sum + day.count, 0);
          
          // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
          periodStatsElement.innerHTML = `
            <div class="db-stats">
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
              </div>
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
              </div>
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                <div class="db-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</div>
              </div>
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                <div class="db-stat-label">ŸÖÿπÿØŸÑ ÿßŸÑŸÜŸÖŸà üìä</div>
              </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
              <div style="font-size: 0.9rem; opacity: 0.8;">
                üìÖ ÿ¢ÿÆÿ± ÿ™ÿ≠ÿØŸäÿ´: ${new Date().toLocaleString('ar-SA')}
              </div>
            </div>
          `;
          
          console.log("‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠");
          
        } catch (error) {
          console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿµŸÑÿßÿ≠:", error);
          periodStatsElement.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="color: #ff6b6b;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</div>
              <button onclick="fixPeriodStatsDisplay()" class="btn info" style="margin-top: 10px;">üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
            </div>
          `;
        }
      }
      
      // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ•ÿµŸÑÿßÿ≠
      fixPeriodStatsDisplay();
      
      // ÿ¨ÿπŸÑ ÿßŸÑÿØÿßŸÑÿ© ŸÖÿ™ÿßÿ≠ÿ© ÿπÿßŸÑŸÖŸäÿßŸã
      window.fixPeriodStatsDisplay = fixPeriodStatsDisplay;
      
    }, 5000); // ÿ™ÿ£ÿÆŸäÿ± 5 ÿ´ŸàÿßŸÜ

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage (ÿ®ÿµŸÖÿ™)
    function loadLocalData() {
      try {
        const stored = localStorage.getItem('barcodeData');
        if (stored) {
          const data = JSON.parse(stored);
          barcodeDatabase = new Set(data.barcodes || []);
          barcodeTimes = data.times || {};
          repeatedBarcodes = new Set(data.repeated || []);
          newBarcodes = data.newBarcodes || [];
          console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage");
        }
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
      }
    }

    // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ≠ÿßŸÑÿ© ŸÖÿπ ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸáŸÖÿ©
    function showMessage(message, type = "success", duration = 4000) {
      // ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸáŸÖÿ©
      if (message.includes("ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™") || 
          message.includes("ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ") || 
          message.includes("ÿ™ŸáŸäÿ¶ÿ©") ||
          message.includes("ÿ®ÿØÿ° ÿßŸÑÿ®ÿ≠ÿ´") ||
          message.includes("ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß") ||
          message.includes("ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™") ||
          message.includes("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´") ||
          message.includes("ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´") ||
          message.includes("ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ") ||
          message.includes("ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ") ||
          message.includes("ÿßŸÑŸÜÿµÿßÿ¶ÿ≠")) {
        return; // ÿ™ÿ¨ÿßŸáŸÑ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
      }

      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      statusMessages.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, duration);
    }

    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä localStorage
    function saveLocalData() {
      try {
    const data = {
      barcodes: Array.from(barcodeDatabase),
      times: barcodeTimes,
          repeated: Array.from(repeatedBarcodes),
          newBarcodes: newBarcodes
    };
    localStorage.setItem('barcodeData', JSON.stringify(data));
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
      }
    }

    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™
    async function getCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(device => device.kind === 'videoinput');
        console.log("ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ©:", cameras.length);
        
        if (cameras.length > 1) {
          cameraSwitch.style.display = 'block';
        }
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿßÿ™:", error);
      }
    }

    // ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß (ÿ®ÿØŸàŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≤ÿßÿ¶ÿØÿ©)
    async function startCamera(deviceId = null) {
      try {
        console.log("üé¨ ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß...");
        
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
          currentTrack = null;
        }

        const constraints = {
          video: {
            facingMode: deviceId ? undefined : "environment",
            width: { ideal: 1920, min: 640 },
            height: { ideal: 1080, min: 480 },
            frameRate: { ideal: 30, min: 15 },
            focusMode: "continuous",
            exposureMode: "continuous",
            whiteBalanceMode: "continuous"
          }
        };

        if (deviceId) {
          constraints.video.deviceId = { exact: deviceId };
        }

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        currentTrack = currentStream.getVideoTracks()[0];
        
        console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß");
        
        video.onloadedmetadata = () => {
          console.log("üì∫ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅŸäÿØŸäŸà");
          
          video.play().then(() => {
            console.log("‚ñ∂Ô∏è ÿ®ÿØÿ£ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà");
            // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠
            
            setTimeout(() => {
              if (!isScanning) {
                startScanning();
              }
            }, 1000);
            
          }).catch(error => {
            console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà:", error);
            showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸäÿØŸäŸà", "error");
          });
        };

      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß:", error);
        
        let errorMessage = "ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß";
        if (error.name === 'NotAllowedError') {
          errorMessage = "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ£ÿ∞ŸàŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß";
        } else if (error.name === 'NotFoundError') {
          errorMessage = "ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÉÿßŸÖŸäÿ±ÿß ŸÅŸä ÿßŸÑÿ¨Ÿáÿßÿ≤";
        }
        
        showMessage("‚ùå " + errorMessage, "error");
      }
    }

    // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÅŸÑÿßÿ¥ (ÿ®ÿØŸàŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≤ÿßÿ¶ÿØÿ©)
    flashToggle.addEventListener("click", async () => {
      if (!currentTrack) return;

      try {
        const capabilities = currentTrack.getCapabilities();
        if (capabilities.torch) {
          flashEnabled = !flashEnabled;
          await currentTrack.applyConstraints({
            advanced: [{ torch: flashEnabled }]
          });
          
          flashToggle.textContent = flashEnabled ? "üî¶ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÅŸÑÿßÿ¥" : "üî¶ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸÑÿßÿ¥";
          flashToggle.className = flashEnabled ? "btn flash-on" : "btn flash-off";
          
          // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÅŸÑÿßÿ¥
        } else {
          showMessage("‚ùå ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑŸÅŸÑÿßÿ¥", "error");
        }
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸÑÿßÿ¥:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÅŸÑÿßÿ¥", "error");
      }
    });

    // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß (ÿ®ÿØŸàŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≤ÿßÿ¶ÿØÿ©)
    cameraSwitch.addEventListener("click", () => {
      if (cameras.length > 1) {
        currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
        startCamera(cameras[currentCameraIndex].deviceId);
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß
      }
    });

    // ÿ™ÿ≠ÿØŸäÿ´ ŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
    function updateLists() {
      // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
      if (newBarcodes.length === 0) {
        newBarcodesList.innerHTML = '<div style="text-align: center; opacity: 0.7;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿ¨ÿØŸäÿØÿ©</div>';
      } else {
        newBarcodesList.innerHTML = newBarcodes.slice(-5).reverse().map(barcode => 
          `<div class="barcode-item">${barcode}</div>`
        ).join('');
      }

      // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
      const repeatedArray = Array.from(repeatedBarcodes);
      if (repeatedArray.length === 0) {
        repeatedBarcodesList.innerHTML = '<div style="text-align: center; opacity: 0.7;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ŸÖŸÉÿ±ÿ±ÿ©</div>';
      } else {
        repeatedBarcodesList.innerHTML = repeatedArray.slice(-5).reverse().map(barcode => 
          `<div class="barcode-item repeated">${barcode}</div>`
        ).join('');
      }
    }

    // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
    async function saveToServer(barcode) {
      try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÖÿØÿÆŸÑÿßÿ™
        if (!barcode || barcode.trim() === '') {
          console.warn("‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ŸÅÿ∏ ÿ®ÿßÿ±ŸÉŸàÿØ ŸÅÿßÿ±ÿ∫ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ");
          return { success: false, isDuplicate: false };
        }

        const cleanBarcode = barcode.trim();
        
        if (cleanBarcode.length < 1 || cleanBarcode.length > 100) {
          console.warn("‚ö†Ô∏è ÿ∑ŸàŸÑ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ ŸÑŸÑÿ≠ŸÅÿ∏:", cleanBarcode);
          return { success: false, isDuplicate: false };
        }

        console.log("üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ:", cleanBarcode);

        const response = await fetch("/add_barcode", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ barcode: cleanBarcode })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log("‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠");
          console.log("üìù ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑÿÆÿßÿØŸÖ:", result);
          
          // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
          if (result.is_duplicate) {
            const duplicateInfo = {
              barcode: result.barcode,
              scan_number: result.scan_number,
              last_scan_datetime: result.last_scan_datetime,
              time_ago: result.time_ago,
              total_scans: result.total_scans
            };
            
            console.log("üîÑ ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ± - ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©:", duplicateInfo);
            
            // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÅÿµŸäŸÑŸäÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
            const duplicateMessage = `üîÑ ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ±: ${result.barcode}\n` +
                                   `üìä ÿßŸÑŸÖÿ≥ÿ≠ ÿ±ŸÇŸÖ: ${result.scan_number}\n` +
                                   `‚è∞ ÿ¢ÿÆÿ± ŸÖÿ≥ÿ≠: ${result.time_ago}\n` +
                                   `üìà ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ≠ÿßÿ™: ${result.total_scans}`;
            
            showMessage(duplicateMessage, "warning", 8000); // ÿπÿ±ÿ∂ ŸÑŸÖÿØÿ© 8 ÿ´ŸàÿßŸÜ
            
            return { 
              success: true, 
              isDuplicate: true, 
              duplicateInfo: duplicateInfo,
              result: result
            };
          } else {
            // ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ
            console.log("‚ú® ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ ÿ™ŸÖ ÿ≠ŸÅÿ∏Ÿá");
            showMessage(`‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ: ${result.barcode}`, "success");
            
            return { 
              success: true, 
              isDuplicate: false,
              result: result
            };
          }
        } else {
          const errorText = await response.text();
          console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ:");
          console.error("üìÑ ŸÉŸàÿØ ÿßŸÑÿÆÿ∑ÿ£:", response.status);
          console.error("üìÑ ŸÜÿµ ÿßŸÑÿÆÿ∑ÿ£:", errorText);
          
          if (response.status === 400) {
            showMessage("‚ùå ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©", "error");
          } else if (response.status === 500) {
            showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ", "error");
          } else {
            showMessage("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ", "error");
          }
          
          return { success: false, isDuplicate: false };
        }
        
    } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ:", error);
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          console.error("üåê ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ¥ÿ®ŸÉÿ©");
          showMessage("‚ùå ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ¥ÿ®ŸÉÿ©", "error");
        } else {
          showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ", "error");
        }
        
        return { success: false, isDuplicate: false };
      }
    }

    // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ŸÑŸâ ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ ŸÖÿπ ÿ±ÿ≥ÿßÿ¶ŸÑ ŸÖÿ®ÿ≥ÿ∑ÿ©
    async function sendToTelegram(barcode, imageData, caption) {
      if (!botToken || !chatId) {
        console.error("‚ùå ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ©");
        showMessage("‚ùå ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ∫Ÿäÿ± ŸÖŸÉÿ™ŸÖŸÑÿ©", "error");
        return false;
      }

      const startTime = Date.now();
      let messageId = null;

      try {
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
        const response = await fetch('/api/telegram/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: barcode,
            status: 'pending',
            chat_id: chatId,
            caption: caption,
            data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed'
          })
        });

        if (response.ok) {
          const result = await response.json();
          messageId = result.message_id;
        }

        // ÿ™ÿ≠ÿ∂Ÿäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ•ÿ±ÿ≥ÿßŸÑ
        const blob = await (await fetch(imageData)).blob();
        const file = new File([blob], `barcode_${barcode}.jpg`, { type: 'image/jpeg' });

        const formData = new FormData();
        formData.append('photo', file);
        formData.append('chat_id', chatId);
        if (caption) {
          formData.append('caption', caption);
        }

        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ
        const telegramResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
          method: 'POST',
          body: formData
        });

        const responseTime = Date.now() - startTime;
        const telegramResult = await telegramResponse.json();

        if (telegramResponse.ok && telegramResult.ok) {
          // ŸÜÿ¨ÿ≠ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ - ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ≠ŸÑŸäÿßŸã
          let imagePath = null;
          try {
            const saveImageResponse = await fetch('/api/telegram/upload-image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                barcode: barcode,
                image_data: imageData
              })
            });
            
            if (saveImageResponse.ok) {
              const saveResult = await saveImageResponse.json();
              imagePath = saveResult.filename;
              console.log(`üíæ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ©: ${imagePath}`);
            } else {
              console.warn("‚ö†Ô∏è ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ≠ŸÑŸäÿßŸã");
            }
          } catch (saveError) {
            console.warn("‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ≠ŸÑŸäÿßŸã:", saveError);
          }

          // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÜÿ¨ÿßÿ≠ ŸÖÿπ ŸÖÿ≥ÿßÿ± ÿßŸÑÿµŸàÿ±ÿ©
          await fetch('/api/telegram/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              barcode: barcode,
              status: 'success',
              message_id: telegramResult.result.message_id.toString(),
              chat_id: chatId,
              caption: caption,
              image_size: blob.size,
              response_time: responseTime,
              data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed',
              image_path: imagePath
            })
          });

          showMessage("ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ", "success");
          console.log(`‚úÖ ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ${barcode} ÿ•ŸÑŸâ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠`);
          return true;

        } else {
          // ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ
          const errorMessage = telegramResult.description || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
          
          await fetch('/api/telegram/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              barcode: barcode,
              status: 'failed',
              error_code: telegramResult.error_code?.toString(),
              error_message: errorMessage,
              response_time: responseTime,
              chat_id: chatId,
              caption: caption,
              data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed'
            })
          });

          console.error(`‚ùå ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ${barcode}:`, errorMessage);
          showMessage("‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ", "error");
          return false;
        }

      } catch (error) {
        const responseTime = Date.now() - startTime;
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ∑ÿ£ ÿßŸÑÿ¥ÿ®ŸÉÿ©
        await fetch('/api/telegram/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: barcode,
            status: 'failed',
            error_message: error.message,
            response_time: responseTime,
            chat_id: chatId,
            caption: caption,
            data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed'
          })
        });

        console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ${barcode}:`, error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©", "error");
        return false;
      }
    }

    // ÿßŸÑÿ™ŸÇÿßÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    function captureImage(barcode) {
      try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÖÿØÿÆŸÑÿßÿ™
        if (!barcode || barcode.trim() === '') {
          console.warn("‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ŸÇÿßÿ∑ ÿµŸàÿ±ÿ© ÿ®ÿØŸàŸÜ ÿ®ÿßÿ±ŸÉŸàÿØ");
          return false;
        }

        if (!video.videoWidth || !video.videoHeight) {
          console.warn("‚ö†Ô∏è ÿßŸÑŸÅŸäÿØŸäŸà ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ ŸÑŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ©");
          showMessage("‚ö†Ô∏è ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ©", "warning");
          return false;
        }

        console.log("üì∏ ÿßŸÑÿ™ŸÇÿßÿ∑ ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ:", barcode.trim());

        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        
        // ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÖŸÜ ÿßŸÑŸÅŸäÿØŸäŸà
        ctx.drawImage(video, 0, 0);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸäÿ≥ÿ™ ÿ≥ŸàÿØÿßÿ° ÿ£Ÿà ŸÅÿßÿ±ÿ∫ÿ©
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let totalBrightness = 0;
        
        // ÿ≠ÿ≥ÿßÿ® ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ≥ÿ∑Ÿàÿπ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ©
        for (let i = 0; i < data.length; i += 4) {
          totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
        }
        
        const averageBrightness = totalBrightness / (data.length / 4);
        
        if (averageBrightness < 10) {
          console.warn("‚ö†Ô∏è ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ∏ŸÑŸÖÿ© ÿ¨ÿØÿßŸã ÿ£Ÿà ŸÅÿßÿ±ÿ∫ÿ©");
          showMessage("‚ö†Ô∏è ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿ∏ŸÑŸÖÿ© ÿ¨ÿØÿßŸã", "warning");
          return false;
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿÆŸÑŸÅŸäÿ© ÿ¥ŸÅÿßŸÅÿ© ŸÑŸÑŸÜÿµ
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(10, 10, canvas.width - 20, 100);
        
        // ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™
        const now = new Date();
        const arabicDate = now.toLocaleString('ar-IQ', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZone: 'Asia/Baghdad'
        });
        
        // ÿ•ÿπÿØÿßÿØ ÿßŸÑŸÜÿµ
        ctx.font = "bold 18px Cairo";
        ctx.fillStyle = "#00ff88";
        ctx.textAlign = "right";
        
        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÑŸÑÿπÿ±ÿ∂
        let displayBarcode = barcode.trim();
        if (displayBarcode.startsWith("00")) {
          displayBarcode = displayBarcode.substring(2);
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜÿµŸàÿµ - ÿπÿ±ÿ∂ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÜÿ∏ŸäŸÅ ŸÅŸÇÿ∑
        ctx.fillText(displayBarcode, canvas.width - 20, 35);
        ctx.fillText(arabicDate, canvas.width - 20, 60);
        ctx.fillText("ŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ±", canvas.width - 20, 85);
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿ∑ÿßÿ± ÿ≤ÿÆÿ±ŸÅŸä
        ctx.strokeStyle = "#00ff88";
        ctx.lineWidth = 3;
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        
        // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿµŸàÿ±ÿ© ÿπÿßŸÑŸäÿ© ÿßŸÑÿ¨ŸàÿØÿ©
        const imageDataUrl = canvas.toDataURL("image/jpeg", 0.9);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ©
        if (!imageDataUrl || imageDataUrl === 'data:,') {
          console.error("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ©");
          showMessage("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ©", "error");
          return false;
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÖÿπ ŸÇŸäŸàÿØ ŸÖÿ≠ÿ≥ŸÜÿ© ŸàŸÖÿ™ŸàÿßŸÅŸÇÿ©
        const sizeInBytes = Math.round((imageDataUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
        const sizeInKB = sizeInBytes / 1024;
        console.log("üìä ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ©:", sizeInKB.toFixed(2) + " KB");
        
        // ŸÇŸäŸàÿØ ŸÖÿ≠ÿ≥ŸÜÿ© ŸàŸÖÿ™ŸàÿßŸÅŸÇÿ© ŸÖÿπ sendToTelegram
        if (sizeInBytes < 512) { // 512 ÿ®ÿßŸäÿ™ ŸÉÿ≠ÿØ ÿ£ÿØŸÜŸâ (ŸÖÿ™ŸàÿßŸÅŸÇ ŸÖÿπ sendToTelegram)
          console.warn("‚ö†Ô∏è ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿµÿ∫Ÿäÿ± ÿ¨ÿØÿßŸã");
          showMessage("‚ö†Ô∏è ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿµÿ∫Ÿäÿ± ÿ¨ÿØÿßŸã - ÿ≥Ÿäÿ™ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿπ ÿ¨ŸàÿØÿ© ÿ£ÿπŸÑŸâ", "warning");
          
          // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ŸÜÿ™ÿßÿ¨ ÿµŸàÿ±ÿ© ÿ®ÿ¨ŸàÿØÿ© ÿ£ÿπŸÑŸâ
          const higherQualityUrl = canvas.toDataURL("image/jpeg", 0.95);
          const newSize = Math.round((higherQualityUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
          
          if (newSize >= 512) {
            console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ:", (newSize / 1024).toFixed(2) + " KB");
            return sendToTelegram(barcode, higherQualityUrl, barcode);
          } else {
            showMessage("‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ©", "warning");
            return false;
          }
        }
        
        if (sizeInBytes > 20 * 1024 * 1024) { // 20MB ŸÉÿ≠ÿØ ÿ£ŸÇÿµŸâ (ŸÖÿ™ŸàÿßŸÅŸÇ ŸÖÿπ sendToTelegram)
          console.warn("‚ö†Ô∏è ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã");
          showMessage("‚ö†Ô∏è ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ŸÉÿ®Ÿäÿ± ÿ¨ÿØÿßŸã - ÿ≥Ÿäÿ™ŸÖ ÿ∂ÿ∫ÿ∑Ÿáÿß", "warning");
          
          // ŸÖÿ≠ÿßŸàŸÑÿ© ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
          const compressedUrl = canvas.toDataURL("image/jpeg", 0.7);
          const compressedSize = Math.round((compressedUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
          
          
          if (compressedSize <= 20 * 1024 * 1024) {
            console.log("‚úÖ ÿ™ŸÖ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ•ŸÑŸâ:", (compressedSize / 1024).toFixed(2) + " KB");
            return sendToTelegram(barcode, compressedUrl, barcode);
          } else {
            showMessage("‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÖÿß ŸÅŸäŸá ÿßŸÑŸÉŸÅÿßŸäÿ©", "warning");
            return false;
          }
        }
        
        console.log("‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠");
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ŸÑŸâ ÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ
        const sendResult = sendToTelegram(barcode, imageDataUrl, barcode);
        return sendResult;
        
    } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ©:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ©", "error");
        return false;
      }
    }

    // ÿ±ÿ≥ŸÖ ÿ•ÿ∑ÿßÿ± ÿ≠ŸàŸÑ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
    function drawFrame(location, color, text) {
    const { topLeftCorner, topRightCorner, bottomRightCorner, bottomLeftCorner } = location;
      
      context.strokeStyle = color;
      context.lineWidth = 4;
    context.beginPath();
    context.moveTo(topLeftCorner.x, topLeftCorner.y);
    context.lineTo(topRightCorner.x, topRightCorner.y);
    context.lineTo(bottomRightCorner.x, bottomRightCorner.y);
    context.lineTo(bottomLeftCorner.x, bottomLeftCorner.y);
    context.closePath();
    context.stroke();

      // ÿßŸÑŸÜÿµ
    context.fillStyle = color;
      context.font = "bold 16px Cairo";
      context.fillText(text, topLeftCorner.x, topLeftCorner.y - 10);
    }

    // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ™ÿ¥ŸÅ ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    function handleBarcode(code) {
      try {
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÖÿØÿÆŸÑÿßÿ™
        if (!code || !code.data) {
          console.warn("‚ö†Ô∏è ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅÿßÿ±ÿ∫ÿ©");
          return false;
        }

        const barcode = code.data.trim();
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÑŸäÿ≥ ŸÅÿßÿ±ÿ∫ÿßŸã
        if (!barcode || barcode === '') {
          console.warn("‚ö†Ô∏è ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅÿßÿ±ÿ∫ ÿ®ÿπÿØ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ");
          showMessage("‚ö†Ô∏è ÿ®ÿßÿ±ŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠", "warning");
          return false;
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ∑ŸàŸÑ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ (ŸÇÿ®ŸàŸÑ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ±ŸÇŸÖŸäÿ© ÿßŸÑŸÇÿµŸäÿ±ÿ©)
        if (barcode.length < 1) {
          console.warn("‚ö†Ô∏è ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅÿßÿ±ÿ∫:", barcode);
          showMessage("‚ö†Ô∏è ÿ®ÿßÿ±ŸÉŸàÿØ ŸÅÿßÿ±ÿ∫", "warning");
          return false;
        }

        if (barcode.length > 100) {
          console.warn("‚ö†Ô∏è ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ∑ŸàŸäŸÑ ÿ¨ÿØÿßŸã:", barcode);
          showMessage("‚ö†Ô∏è ÿ®ÿßÿ±ŸÉŸàÿØ ÿ∑ŸàŸäŸÑ ÿ¨ÿØÿßŸã", "warning");
          return false;
        }

        console.log("üîç ŸÖÿπÿßŸÑÿ¨ÿ© ÿ®ÿßÿ±ŸÉŸàÿØ ÿµÿ≠Ÿäÿ≠:", barcode, "ÿ∑ŸàŸÑ:", barcode.length);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÜŸàÿπ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
        const isNumeric = /^\d+$/.test(barcode);
        const barcodeInfo = {
          data: barcode,
          length: barcode.length,
          type: isNumeric ? "ÿ±ŸÇŸÖŸä" : "ŸÜÿµŸä/ŸÖÿÆÿ™ŸÑÿ∑",
          originalCode: code
        };
        
        console.log("üìã ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ:", barcodeInfo);
        
    const now = Date.now();
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ÿßŸÑŸÇÿßÿπÿØÿ©
        if (barcodeDatabase.has(barcode)) {
          const timeDiff = (now - barcodeTimes[barcode]) / 1000;
          
          if (timeDiff < 20) {
            // ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ± ÿ≠ÿØŸäÿ´ - ŸÖŸÜÿπ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±
            drawFrame(code.location, "#ffa726", `‚è±Ô∏è ${Math.ceil(20 - timeDiff)}s`);
            console.log(`‚è≥ ÿ®ÿßÿ±ŸÉŸàÿØ ÿ≠ÿØŸäÿ´ÿå ÿßŸÜÿ™ÿ∏ÿßÿ± ${Math.ceil(20 - timeDiff)} ÿ´ÿßŸÜŸäÿ©`);
          } else {
            // ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ± ŸÇÿØŸäŸÖ
            drawFrame(code.location, "#ff6b6b", "‚ùå ŸÖŸÉÿ±ÿ±");
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿßÿ™ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
            if (!repeatedBarcodes.has(barcode)) {
              repeatedBarcodes.add(barcode);
              console.log("üìù ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿßÿ™:", barcode);
            }
            
            showMessage(`‚ö†Ô∏è ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ±: ${barcode}`, "warning");
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
            showDuplicateBarcodeImage(barcode);
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
            showDuplicateBarcodeImage(barcode);
          }
        } else {
          // ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ
          console.log("‚úÖ ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ:", barcode);
          
          // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
          barcodeDatabase.add(barcode);
          barcodeTimes[barcode] = now;
          
          // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
          if (!newBarcodes.includes(barcode)) {
            newBarcodes.push(barcode);
          }
          
          // ÿ±ÿ≥ŸÖ ÿßŸÑÿ•ÿ∑ÿßÿ± ÿßŸÑÿ£ÿÆÿ∂ÿ±
          drawFrame(code.location, "#00ff88", "‚úÖ ÿ¨ÿØŸäÿØ");
          
          // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÜÿ¨ÿßÿ≠ ŸÖÿπ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
          let displayBarcode = barcode;
          if (barcode.startsWith("00")) {
            displayBarcode = barcode.substring(2);
          }
          
          const barcodeType = code.barcodeType || "ÿ®ÿßÿ±ŸÉŸàÿØ";
          const dataType = isNumeric ? "ÿ±ŸÇŸÖŸä" : "ŸÖÿÆÿ™ŸÑÿ∑";
          showMessage(`‚úÖ ${barcodeType} ${dataType} ÿ¨ÿØŸäÿØ: ${displayBarcode} (${barcode.length} ÿ±ŸÇŸÖ/ÿ≠ÿ±ŸÅ)`, "success");
          
          // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿßŸÑÿ™ŸÜÿ®ŸäŸá
          if (beepSound) {
            beepSound.play().catch(error => {
              console.log("üîá ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™:", error.message);
            });
          }
          
          // ÿ≠ŸÅÿ∏ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ (ÿ∫Ÿäÿ± ŸÖÿ™ÿ≤ÿßŸÖŸÜ) ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
          saveToServer(barcode).then(saveResult => {
            if (saveResult.success) {
              if (saveResult.isDuplicate) {
                console.log("üîÑ ÿ™ŸÖ ÿßŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ±:", saveResult.duplicateInfo);
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿßÿ™ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                if (!repeatedBarcodes.has(barcode)) {
                  repeatedBarcodes.add(barcode);
                  updateLists();
                  saveLocalData();
                }
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂ ŸÖÿπ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
                showMessage(`üîÑ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ± ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ (ÿßŸÑŸÖÿ±ÿ© ÿ±ŸÇŸÖ ${saveResult.duplicateInfo.scan_number})`, "warning");
              } else {
                console.log("‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ");
              }
            } else {
              console.error("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ");
            }
          }).catch(error => {
            console.error("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ:", error);
          });
          
          // ÿßŸÑÿ™ŸÇÿßÿ∑ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿπÿ®ÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ (ÿ∫Ÿäÿ± ŸÖÿ™ÿ≤ÿßŸÖŸÜ)
          setTimeout(() => {
            captureImageAndQueue(barcode, 'high'); // ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
          }, 100);
        }
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã
        updateLists();
        saveLocalData();
        
        return true;
        
    } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ", "error");
        return false;
      }
    }

    // ÿØÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ŸÑÿ¨ŸÖŸäÿπ ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
    function scanBarcode() {
      if (!isScanning) return;
      
      if (!video.videoWidth || !video.videoHeight) {
        requestAnimationFrame(scanBarcode);
        return;
      }

      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    context.clearRect(0, 0, overlay.width, overlay.height);

      try {
        // ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßŸÜŸÅÿßÿ≥ ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ© ŸÑŸÑŸÖÿ≥ÿ≠
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        
        // ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ©
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿµŸàÿ±ÿ©
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ QR Code ÿ£ŸàŸÑÿßŸã ŸÖÿπ ÿÆŸäÿßÿ±ÿßÿ™ ŸÖÿ™ŸÇÿØŸÖÿ©
        let code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth",
          allowFloatingPoint: true,
          minScore: 0.3
        });

        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ¨ÿØ QRÿå ÿ¨ÿ±ÿ® ŸÖÿπ ÿØŸÇÿ© ÿ£ŸÇŸÑ ŸÑŸÑÿ≥ÿ±ÿπÿ©
        if (!code) {
          const smallCanvas = document.createElement("canvas");
          const scale = 0.5;
          smallCanvas.width = canvas.width * scale;
          smallCanvas.height = canvas.height * scale;
          const smallCtx = smallCanvas.getContext("2d");
          smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
          
          const smallImageData = smallCtx.getImageData(0, 0, smallCanvas.width, smallCanvas.height);
          code = jsQR(smallImageData.data, smallImageData.width, smallImageData.height, {
            inversionAttempts: "attemptBoth"
          });
        }

        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ¨ÿØ QRÿå ÿ¨ÿ±ÿ® ŸÖÿπ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ©
        if (!code) {
          const enhancedData = enhanceImageForScanning(imageData);
          code = jsQR(enhancedData.data, enhancedData.width, enhancedData.height, {
            inversionAttempts: "attemptBoth"
          });
        }

        // ÿ•ÿ∞ÿß ŸàŸèÿ¨ÿØ QR Codeÿå ŸÖÿπÿßŸÑÿ¨ÿ™Ÿá ŸÖÿ®ÿßÿ¥ÿ±ÿ© ŸÖÿπ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ
        if (code && code.data && code.data.trim() !== '') {
          console.log("üéØ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ QR Code:", code.data);
          code.barcodeType = "QR Code";
          
          // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸÖŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ÿ£ŸàŸÑÿßŸã
          checkDuplicateAndHandle(code);
      } else {
          // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ®ÿßÿ±ŸÉŸàÿØ ÿπÿßÿØŸä ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸàÿ¨ÿØ QR Code
          scanRegularBarcode(canvas).then(regularCode => {
            if (regularCode && regularCode.data && regularCode.data.trim() !== '') {
              console.log("üéØ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ÿßÿ±ŸÉŸàÿØ ÿπÿßÿØŸä:", regularCode.data);
              regularCode.barcodeType = "Barcode";
              handleBarcode(regularCode);
            }
          }).catch(error => {
            console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ®ÿßÿ±ŸÉŸàÿØ ÿπÿßÿØŸä:", error);
          });
        }

        // ÿ±ÿ≥ŸÖ ÿÆÿ∑ ÿßŸÑŸÖÿ≥ÿ≠ ŸàÿßŸÑÿ•ÿ∑ÿßÿ±ÿßÿ™
        drawScannerFrame();

      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ≠:", error);
    }

    requestAnimationFrame(scanBarcode);
  }

    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸÑŸÖÿ≥ÿ≠
    function enhanceImageForScanning(imageData) {
      const data = imageData.data;
      const enhancedData = new Uint8ClampedArray(data.length);
      
      for (let i = 0; i < data.length; i += 4) {
        // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿ±ŸÖÿßÿØŸä
        const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
        
        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ™ÿ®ÿßŸäŸÜ
        const enhanced = gray > 128 ? 255 : 0;
        
        enhancedData[i] = enhanced;     // R
        enhancedData[i + 1] = enhanced; // G
        enhancedData[i + 2] = enhanced; // B
        enhancedData[i + 3] = 255;      // A
      }
      
      return new ImageData(enhancedData, imageData.width, imageData.height);
    }

    // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑÿπÿßÿØŸä (Code128, Code39, EAN, UPC, ÿ•ŸÑÿÆ)
    function scanRegularBarcode(canvas) {
      try {
        if (!window.Quagga) {
          console.warn("ŸÖŸÉÿ™ÿ®ÿ© QuaggaJS ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±ÿ©");
          return null;
        }

        return new Promise((resolve) => {
          // ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßŸÜŸÅÿßÿ≥ ŸÖÿ§ŸÇÿ™ ÿ£ÿµÿ∫ÿ± ŸÑŸÑÿ≥ÿ±ÿπÿ©
          const tempCanvas = document.createElement('canvas');
          const scale = 0.7;
          tempCanvas.width = canvas.width * scale;
          tempCanvas.height = canvas.height * scale;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

          // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ ÿ•ŸÑŸâ URL
          const imageUrl = tempCanvas.toDataURL('image/jpeg', 0.7);

          // ÿ™ŸÉŸàŸäŸÜ Quagga ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
          Quagga.decodeSingle({
            decoder: {
              readers: [
                "code_128_reader",
                "ean_reader", 
                "ean_8_reader",
                "code_39_reader",
                "code_39_vin_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
              ]
            },
            locate: true,
            src: imageUrl
          }, function(result) {
            if (result && result.codeResult && result.codeResult.code) {
              console.log("üéØ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ÿßÿ±ŸÉŸàÿØ ÿπÿßÿØŸä:", result.codeResult.code);
              
              // ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ¶ŸÜ ŸÖÿ¥ÿßÿ®Ÿá ŸÑŸÄ jsQR
              const fakeLocation = {
                topLeftCorner: { x: 50, y: 50 },
                topRightCorner: { x: canvas.width - 50, y: 50 },
                bottomRightCorner: { x: canvas.width - 50, y: canvas.height - 50 },
                bottomLeftCorner: { x: 50, y: canvas.height - 50 }
              };
              
              resolve({
                data: result.codeResult.code,
                location: fakeLocation
              });
    } else {
              resolve(null);
            }
          });

          // ŸÖŸáŸÑÿ© ÿ≤ŸÖŸÜŸäÿ© ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ™ÿπŸÑŸäŸÇ
          setTimeout(() => {
            resolve(null);
          }, 500);
        });

      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑÿπÿßÿØŸä:", error);
        return null;
      }
    }

    // ÿ±ÿ≥ŸÖ ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
    function drawScannerFrame() {
      if (!context || !overlay.width || !overlay.height) return;
      
      try {
        // ÿ±ÿ≥ŸÖ ÿßŸÑÿÆÿ∑ ÿßŸÑŸÖÿ™ÿ≠ÿ±ŸÉ ŸÅŸä ÿßŸÑŸàÿ≥ÿ∑
        const centerY = overlay.height / 2;
        const time = Date.now() * 0.003;
        const scanLineY = centerY + Math.sin(time) * 50;
        
        const gradient = context.createLinearGradient(0, scanLineY - 2, 0, scanLineY + 2);
        gradient.addColorStop(0, "transparent");
        gradient.addColorStop(0.5, "#00ff88");
        gradient.addColorStop(1, "transparent");
        
        context.fillStyle = gradient;
        context.fillRect(0, scanLineY - 1, overlay.width, 3);
        
        // ÿ±ÿ≥ŸÖ ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖÿ≥ÿ≠
        const centerX = overlay.width / 2;
        const frameSize = Math.min(overlay.width, overlay.height) * 0.6;
        const frameX = centerX - frameSize / 2;
        const frameY = centerY - frameSize / 2;
        
        const cornerSize = 30;
        const cornerWidth = 4;
        
        context.strokeStyle = "#00ff88";
        context.lineWidth = cornerWidth;
        context.setLineDash([]);
        
        // ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑÿπŸÑŸàŸäÿ© ÿßŸÑŸäÿ≥ÿ±Ÿâ
        context.beginPath();
        context.moveTo(frameX, frameY + cornerSize);
        context.lineTo(frameX, frameY);
        context.lineTo(frameX + cornerSize, frameY);
        context.stroke();
        
        // ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑÿπŸÑŸàŸäÿ© ÿßŸÑŸäŸÖŸÜŸâ
        context.beginPath();
        context.moveTo(frameX + frameSize - cornerSize, frameY);
        context.lineTo(frameX + frameSize, frameY);
        context.lineTo(frameX + frameSize, frameY + cornerSize);
        context.stroke();
        
        // ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑÿ≥ŸÅŸÑŸäÿ© ÿßŸÑŸäÿ≥ÿ±Ÿâ
        context.beginPath();
        context.moveTo(frameX, frameY + frameSize - cornerSize);
        context.lineTo(frameX, frameY + frameSize);
        context.lineTo(frameX + cornerSize, frameY + frameSize);
        context.stroke();
        
        // ÿßŸÑÿ≤ÿßŸàŸäÿ© ÿßŸÑÿ≥ŸÅŸÑŸäÿ© ÿßŸÑŸäŸÖŸÜŸâ
        context.beginPath();
        context.moveTo(frameX + frameSize - cornerSize, frameY + frameSize);
        context.lineTo(frameX + frameSize, frameY + frameSize);
        context.lineTo(frameX + frameSize, frameY + frameSize - cornerSize);
        context.stroke();
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿµ ÿ•ÿ±ÿ¥ÿßÿØŸä
        context.font = "16px Cairo";
        context.fillStyle = "#ffffff";
        context.textAlign = "center";
        context.fillText("Ÿàÿ¨Ÿá ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÜÿ≠Ÿà ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ£Ÿà QR Code", centerX, frameY + frameSize + 40);
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÇÿßÿ∑ ŸÑŸÑŸÖÿ≥ÿßÿπÿØÿ© ŸÅŸä ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤
        context.fillStyle = "#00ff88";
        const dotSize = 3;
        const dotPositions = [
          [frameX + frameSize/4, frameY + frameSize/4],
          [frameX + 3*frameSize/4, frameY + frameSize/4],
          [frameX + frameSize/4, frameY + 3*frameSize/4],
          [frameX + 3*frameSize/4, frameY + 3*frameSize/4]
        ];
        
        dotPositions.forEach(([x, y]) => {
          context.beginPath();
          context.arc(x, y, dotSize, 0, 2 * Math.PI);
          context.fill();
        });
        
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ±ÿ≥ŸÖ ÿ•ÿ∑ÿßÿ± ÿßŸÑŸÖÿ≥ÿ≠:", error);
      }
    }

    // ÿ®ÿØÿ° ÿßŸÑŸÖÿ≥ÿ≠ (ÿ®ÿØŸàŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≤ÿßÿ¶ÿØÿ©)
    function startScanning() {
      if (isScanning) return;
      
      isScanning = true;
      console.log("üîç ÿ®ÿØÿ° ÿßŸÑŸÖÿ≥ÿ≠...");
      // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ®ÿØÿ° ÿßŸÑÿ®ÿ≠ÿ´
      scanBarcode();
    }

    // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ≥ÿ≠
    function stopScanning() {
      isScanning = false;
      console.log("‚èπÔ∏è ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ≥ÿ≠");
      if (context) {
        context.clearRect(0, 0, overlay.width, overlay.height);
      }
    }

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ (ÿ®ÿµŸÖÿ™)
    async function loadFromServer() {
      try {
        const response = await fetch("/get_barcodes");
        if (!response.ok) {
          throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©: ${response.status}`);
        }
        
        const serverBarcodes = await response.json();
        if (!Array.isArray(serverBarcodes)) {
          throw new Error("ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©");
        }
        
        serverBarcodes.forEach(([barcode, timestamp, dataType, length]) => {
          if (barcode && timestamp) {
            barcodeDatabase.add(barcode);
            barcodeTimes[barcode] = timestamp * 1000;
            if (!newBarcodes.includes(barcode)) {
              newBarcodes.push(barcode);
            }
          }
        });
        
        updateLists();
        saveLocalData();
        
        await loadDatabaseStats();
        await loadPeriodStats();
        
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿÆÿßÿØŸÖ:", error);
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
        updateLists();
      }
    }

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ (ÿ®ÿµŸÖÿ™)
    async function loadDatabaseStats() {
      try {
        const response = await fetch("/stats");
        if (!response.ok) {
          throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ©: ${response.status}`);
        }
        
        const stats = await response.json();
        if (!stats || typeof stats !== 'object') {
          throw new Error("ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ© ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠ÿ©");
        }
        
        displayDatabaseStats(stats);
        
      } catch (error) {
        console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
        
        databaseStats.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="color: #ff6b6b; margin-bottom: 10px;">
              ‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            </div>
            <div style="font-size: 0.9rem; opacity: 0.7;">
              ${error.message}
            </div>
            <button onclick="loadDatabaseStats()" class="btn info" style="margin-top: 15px;">
              üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
            </button>
          </div>
        `;
      }
    }

    // ÿπÿ±ÿ∂ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    function displayDatabaseStats(stats) {
      const typeBreakdown = stats.type_breakdown || {};
      const numericCount = typeBreakdown.numeric || 0;
      const mixedCount = typeBreakdown.mixed || 0;
      
      databaseStats.innerHTML = `
        <div class="db-stats">
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.total || 0}</div>
            <div class="db-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.today || 0}</div>
            <div class="db-stat-label">ÿßŸÑŸäŸàŸÖ</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${numericCount}</div>
            <div class="db-stat-label">ÿ±ŸÇŸÖŸäÿ©</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${mixedCount}</div>
            <div class="db-stat-label">ŸÖÿÆÿ™ŸÑÿ∑ÿ©</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.failed_frames || 0}</div>
            <div class="db-stat-label">ÿ•ÿ∑ÿßÿ±ÿßÿ™ ŸÅÿßÿ¥ŸÑÿ©</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.database_size_kb || 0}</div>
            <div class="db-stat-label">KB ÿ≠ÿ¨ŸÖ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
          </div>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
          <div style="font-size: 0.9rem; opacity: 0.8;">
            ${stats.last_barcode ? `ÿ¢ÿÆÿ± ÿ®ÿßÿ±ŸÉŸàÿØ: ${stats.last_barcode}` : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿ®ÿπÿØ'}
          </div>
          <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">
            ${stats.last_time ? `ŸÅŸä: ${new Date(stats.last_time * 1000).toLocaleString('ar-IQ', { timeZone: 'Asia/Baghdad' })}` : ''}
          </div>
        </div>
      `;
    }

    // ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
    async function resetDatabaseOnServer() {
      try {
        showMessage("üîÑ ÿ¨ÿßÿ±Ÿä ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...", "success");
        
        const response = await fetch("/reset_database", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        
        if (response.ok) {
          console.log("‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ");
          return true;
        } else {
          const error = await response.text();
          console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
          return false;
        }
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ:", error);
        return false;
      }
    }

    // ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
    function resetLocalDatabase() {
      barcodeDatabase.clear();
      barcodeTimes = {};
      repeatedBarcodes.clear();
      newBarcodes = [];
      
      // ŸÖÿ≥ÿ≠ localStorage
      localStorage.removeItem('barcodeData');
      
      console.log("‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©");
    }

    // ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸÑÿ© (ŸÖÿ≠ŸÑŸä + ÿÆÿßÿØŸÖ)
    async function resetCompleteDatabase() {
      try {
        // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿ£ŸàŸÑÿßŸã
        resetLocalDatabase();
        
        // ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ
        const serverResetSuccess = await resetDatabaseOnServer();
        
        if (serverResetSuccess) {
          // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
    updateLists();
          await loadDatabaseStats();
          
          showMessage("‚úÖ ÿ™ŸÖ ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ", "success");
          return true;
        } else {
          showMessage("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿÆÿßÿØŸÖ", "error");
          return false;
        }
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿ≥ÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™", "error");
        return false;
      }
    }

    // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± v2.0 ‚ö°
    async function initApp() {
      console.log("üöÄ ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± v2.0 ‚ö°...");
      
      try {
        // ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä
        loadLocalData();
        updateLists();
        loadFromServer();
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showMessage("‚ùå ŸÖÿ™ÿµŸÅÿ≠ŸÉ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß", "error");
          return;
        }
        
        // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
        getCameras();
        await startCameraOptimized();
        
        // ÿ®ÿØÿ° ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ±
        startAdvancedScanningSystem();
        
        // ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ∑ÿßÿ®Ÿàÿ±
        startQueueMonitoring();
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        setTimeout(() => {
          loadPeriodStats();
        }, 2000);
        
        console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± ÿ®ŸÜÿ¨ÿßÿ≠! üéØ");
        showMessage("üéâ ŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± v2.0 ÿ¨ÿßŸáÿ≤! ‚ö°", "success");
        
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ: " + error.message, "error");
      }
    }
    
    // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
    async function startCameraOptimized() {
      try {
        console.log("üìπ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©...");
        
        // ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ŸÑŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ±Ÿäÿπ
        const constraints = {
          video: {
            facingMode: currentCamera,
            width: { ideal: 1920, min: 640 },
            height: { ideal: 1080, min: 480 },
            frameRate: { ideal: 60, min: 30 }, // ŸÖÿπÿØŸÑ ÿ•ÿ∑ÿßÿ±ÿßÿ™ ÿπÿßŸÑŸä ŸÑŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ±Ÿäÿπ
            focusMode: 'continuous',
            exposureMode: 'continuous',
            whiteBalanceMode: 'continuous'
          }
        };
        
        // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ™ÿπŸÖŸÑ
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        currentStream = stream;
        
        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            isScanning = true;
            
            // ÿ®ÿØÿ° ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
            scanBarcodeOptimized();
            
            console.log("‚úÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ÿ¨ÿßŸáÿ≤ÿ© ŸÑŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ±Ÿäÿπ");
            resolve();
          };
        });
        
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©:", error);
        // fallback ÿ•ŸÑŸâ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿßŸÑÿπÿßÿØŸäÿ©
        startCamera();
      }
    }
    
    // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ ŸàÿßŸÑÿ≥ÿ±Ÿäÿπ
    function scanBarcodeOptimized() {
      if (!isScanning) return;
      
      if (!video.videoWidth || !video.videoHeight) {
        requestAnimationFrame(scanBarcodeOptimized);
        return;
      }
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      context.clearRect(0, 0, overlay.width, overlay.height);
      
      try {
        // ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ŸÖÿ≥ÿ≠ ŸÖÿ™ŸÇÿØŸÖÿ© ŸàŸÖÿ™ÿπÿØÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™
        let code = null;
        
        // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1: ŸÖÿ≥ÿ≠ ÿ≥ÿ±Ÿäÿπ ÿ®ÿØŸÇÿ© ŸÉÿßŸÖŸÑÿ©
        code = performQuickScan();
        
        // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 2: ŸÖÿ≥ÿ≠ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ
        if (!code) {
          code = performMediumScan();
        }
        
        // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 3: ŸÖÿ≥ÿ≠ ÿπŸÖŸäŸÇ ÿ•ÿ∞ÿß ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑
        if (!code) {
          code = performDeepScan();
        }
        
        // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 4: ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸèÿπÿØ ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ®ÿπŸäÿØÿ©
        if (!code && fastScanEnabled) {
          code = performDistanceScan();
        }
        
        // ÿ•ÿ∞ÿß ŸàŸèÿ¨ÿØ ÿ®ÿßÿ±ŸÉŸàÿØÿå ŸÖÿπÿßŸÑÿ¨ÿ™Ÿá
        if (code && code.data && code.data.trim() !== '') {
          console.log("üéØ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ®ÿßÿ±ŸÉŸàÿØ:", code.data, "ŸÜŸàÿπ:", code.barcodeType || "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ");
          
          // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸÖŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸàŸÖÿπÿßŸÑÿ¨ÿ©
          checkDuplicateAndHandle(code);
        }
        
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ:", error);
      }
      
      // ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ÿßŸÑŸÖÿ≥ÿ≠
      requestAnimationFrame(scanBarcodeOptimized);
    }
    
    // ŸÖÿ≥ÿ≠ ÿ≥ÿ±Ÿäÿπ - ÿ£ÿπŸÑŸâ ÿ£ŸàŸÑŸàŸäÿ©
    function performQuickScan() {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // ŸÖÿ≥ÿ≠ QR ÿ≥ÿ±Ÿäÿπ
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
          allowFloatingPoint: false,
          minScore: 0.5
        });
        
        if (code) {
          code.barcodeType = "QR Code (ÿ≥ÿ±Ÿäÿπ)";
          return code;
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // ŸÖÿ≥ÿ≠ ŸÖÿ™Ÿàÿ≥ÿ∑ - ÿØŸÇÿ© ŸÖÿ™Ÿàÿßÿ≤ŸÜÿ©
    function performMediumScan() {
      try {
        const canvas = document.createElement("canvas");
        const scale = 0.7; // ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ≠ÿ¨ŸÖ ŸÇŸÑŸäŸÑÿßŸã ŸÑŸÑÿ≥ÿ±ÿπÿ©
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth",
          allowFloatingPoint: true,
          minScore: 0.3
        });
        
        if (code) {
          code.barcodeType = "QR Code (ŸÖÿ™Ÿàÿ≥ÿ∑)";
          return code;
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // ŸÖÿ≥ÿ≠ ÿπŸÖŸäŸÇ - ÿ£ÿπŸÑŸâ ÿØŸÇÿ©
    function performDeepScan() {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿπŸÖŸäŸÇ
        const enhancedData = enhanceImageForDeepScanning(imageData);
        
        const code = jsQR(enhancedData.data, enhancedData.width, enhancedData.height, {
          inversionAttempts: "attemptBoth",
          allowFloatingPoint: true,
          minScore: 0.1
        });
        
        if (code) {
          code.barcodeType = "QR Code (ÿπŸÖŸäŸÇ)";
          return code;
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸèÿπÿØ - ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ÿßŸÑÿ®ÿπŸäÿØÿ©
    function performDistanceScan() {
      try {
        // ŸÖÿ≥ÿ≠ ŸÖŸÜÿßÿ∑ŸÇ ŸÖÿ™ÿπÿØÿØÿ© ŸÖŸÜ ÿßŸÑÿµŸàÿ±ÿ©
        const regions = [
          { x: 0, y: 0, w: 0.5, h: 0.5 },           // ÿ£ÿπŸÑŸâ Ÿäÿ≥ÿßÿ±
          { x: 0.5, y: 0, w: 0.5, h: 0.5 },         // ÿ£ÿπŸÑŸâ ŸäŸÖŸäŸÜ
          { x: 0, y: 0.5, w: 0.5, h: 0.5 },         // ÿ£ÿ≥ŸÅŸÑ Ÿäÿ≥ÿßÿ±
          { x: 0.5, y: 0.5, w: 0.5, h: 0.5 },       // ÿ£ÿ≥ŸÅŸÑ ŸäŸÖŸäŸÜ
          { x: 0.25, y: 0.25, w: 0.5, h: 0.5 }      // ÿßŸÑŸÖÿ±ŸÉÿ≤
        ];
        
        for (const region of regions) {
          const canvas = document.createElement("canvas");
          const regionWidth = video.videoWidth * region.w;
          const regionHeight = video.videoHeight * region.h;
          canvas.width = regionWidth;
          canvas.height = regionHeight;
          const ctx = canvas.getContext("2d");
          
          // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
          ctx.drawImage(
            video,
            video.videoWidth * region.x, video.videoHeight * region.y, regionWidth, regionHeight,
            0, 0, regionWidth, regionHeight
          );
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "attemptBoth",
            minScore: 0.2
          });
          
          if (code) {
            code.barcodeType = "QR Code (ÿ®ŸèÿπÿØ)";
            return code;
          }
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿµŸàÿ±ÿ© ŸÑŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿπŸÖŸäŸÇ
    function enhanceImageForDeepScanning(imageData) {
      const data = new Uint8ClampedArray(imageData.data);
      
      // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ™ÿ®ÿßŸäŸÜ ŸàÿßŸÑÿ≥ÿ∑Ÿàÿπ
      for (let i = 0; i < data.length; i += 4) {
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        
        // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ™ÿ®ÿßŸäŸÜ
        const enhanced = gray > 128 ? Math.min(255, gray * 1.2) : Math.max(0, gray * 0.8);
        
        data[i] = enhanced;     // R
        data[i + 1] = enhanced; // G
        data[i + 2] = enhanced; // B
        data[i + 3] = 255;      // A
      }
      
      return new ImageData(data, imageData.width, imageData.height);
    }
    
    // ÿ®ÿØÿ° ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
    function startAdvancedScanningSystem() {
      console.log("‚ö° ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ŸÑŸÑŸÖÿ≥ÿ≠...");
      
      // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ±Ÿäÿπ
      fastScanEnabled = true;
      
      // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿ®ÿµÿ±Ÿäÿ© ŸÑŸÑÿ£ÿØÿßÿ°
      addPerformanceIndicators();
      
      // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß
      optimizeCameraResponse();
      
      console.log("‚úÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ™ŸÇÿØŸÖ ÿ¨ÿßŸáÿ≤!");
    }
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ§ÿ¥ÿ±ÿßÿ™ ÿßŸÑÿ£ÿØÿßÿ° ÿßŸÑÿ®ÿµÿ±Ÿäÿ©
    function addPerformanceIndicators() {
      // ŸÖÿ§ÿ¥ÿ± FPS
      let frameCount = 0;
      let lastTime = performance.now();
      
      setInterval(() => {
        const now = performance.now();
        const fps = Math.round(frameCount * 1000 / (now - lastTime));
        frameCount = 0;
        lastTime = now;
        
        // ÿπÿ±ÿ∂ FPS ŸÅŸä Ÿàÿ≠ÿØÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ
        if (fps > 0) {
          console.log(`üìä FPS: ${fps} | ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ≥ÿ≠: ${fastScanEnabled ? 'ÿ≥ÿ±Ÿäÿπ' : 'ÿπÿßÿØŸä'}`);
        }
      }, 1000);
      
      // ÿπÿØÿßÿØ ÿßŸÑÿ•ÿ∑ÿßÿ±ÿßÿ™
      const countFrames = () => {
        frameCount++;
        requestAnimationFrame(countFrames);
      };
      countFrames();
    }
    
    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß
    function optimizeCameraResponse() {
      // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÅŸäÿØŸäŸà
      if (video.srcObject) {
        const track = video.srcObject.getVideoTracks()[0];
        if (track && track.applyConstraints) {
          track.applyConstraints({
            focusMode: 'continuous',
            exposureMode: 'continuous',
            whiteBalanceMode: 'continuous'
          }).catch(error => {
            console.warn("‚ö†Ô∏è ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß:", error);
          });
        }
      }
    }
    
    // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ∑ÿßÿ®Ÿàÿ±
    function startQueueMonitoring() {
      console.log("üëÄ ÿ®ÿØÿ° ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ∑ÿßÿ®Ÿàÿ± ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ...");
      
      // ÿ™ÿ≠ÿØŸäÿ´ ŸÉŸÑ ÿ´ÿßŸÜŸäÿ™ŸäŸÜ
      queueUpdateInterval = setInterval(async () => {
        await updateQueueIndicator();
      }, 2000);
      
      // ÿ™ÿ≠ÿØŸäÿ´ ŸÅŸàÿ±Ÿä ÿ£ŸàŸÑ ŸÖÿ±ÿ©
      updateQueueIndicator();
    }

    // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    document.addEventListener('DOMContentLoaded', initApp);

    // ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ± ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ
    function addRestartButton() {
      const restartBtn = document.createElement('button');
      restartBtn.textContent = 'üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ';
      restartBtn.className = 'btn';
      restartBtn.onclick = () => {
        location.reload();
      };
      
      const controls = document.querySelector('.controls');
      if (controls && !document.querySelector('.restart-btn')) {
        restartBtn.classList.add('restart-btn');
        controls.appendChild(restartBtn);
      }
    }

    // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≤ÿ± ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(addRestartButton, 2000);
    });

    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπŸÖŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
    window.addEventListener('beforeunload', () => {
      // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
    });

    // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ∫ŸäŸäÿ± ÿ±ÿ§Ÿäÿ© ÿßŸÑÿµŸÅÿ≠ÿ©
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log("üì± ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖÿÆŸÅŸäÿ© - ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÖÿ≥ÿ≠ ŸÖÿ§ŸÇÿ™ÿßŸã");
        stopScanning();
      } else {
        console.log("üì± ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖÿ±ÿ¶Ÿäÿ© - ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ≥ÿ≠");
        setTimeout(() => {
          if (!isScanning && currentStream) {
            startScanning();
          }
        }, 1000);
      }
    });

    // ÿ•ÿ∂ÿßŸÅÿ© ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠
    document.addEventListener('keydown', (event) => {
      switch(event.key) {
        case ' ':
          event.preventDefault();
          if (isScanning) {
            stopScanning();
          } else {
            startScanning();
          }
          break;
        case 'f':
        case 'F':
          event.preventDefault();
          flashToggle.click();
          break;
        case 'c':
        case 'C':
          event.preventDefault();
          cameraSwitch.click();
          break;
        case 'r':
        case 'R':
          event.preventDefault();
          initApp();
          break;
      }
    });

    // ÿπÿ±ÿ∂ ŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ (ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä)
    function showUsageTips() {
      // ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
    }

    // ÿ•ÿ≤ÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑŸÜÿµÿßÿ¶ÿ≠ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
    // setTimeout(showUsageTips, 5000);

    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÑÿ¨ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ (ÿ®ÿØŸàŸÜ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ≤ÿßÿ¶ÿØÿ©)
    refreshStatsBtn.addEventListener('click', async () => {
      try {
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
        await loadFromServer();
        await loadDatabaseStats();
        await loadPeriodStats();
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™", "error");
      }
    });

    restartAppBtn.addEventListener('click', () => {
      // ÿ•ÿ≤ÿßŸÑÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
      setTimeout(() => {
        location.reload();
      }, 500);
    });

    viewDetailedStatsBtn.addEventListener('click', () => {
      statsModal.style.display = 'block';
      loadDetailedStats();
    });

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©
    async function loadDetailedStats() {
      try {
        detailedStatsContent.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©...
          </div>
        `;

        const response = await fetch('/api/detailed-stats');
        if (!response.ok) {
          throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ: ${response.status}`);
        }

        const stats = await response.json();
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©
        detailedStatsContent.innerHTML = `
          <div style="max-height: 500px; overflow-y: auto;">
            
            <!-- ŸÖŸÑÿÆÿµ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">üìä ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑÿπÿßŸÖ</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold; color: #00ff88;">${stats.summary.total_barcodes}</div>
                  <div style="opacity: 0.8;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold; color: #ff6b6b;">${stats.summary.total_scans}</div>
                  <div style="opacity: 0.8;">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ≥ÿ≠ÿßÿ™</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold; color: #ffa726;">${stats.summary.avg_scans_per_barcode}</div>
                  <div style="opacity: 0.8;">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ≥ÿ≠ÿßÿ™</div>
                </div>
              </div>
            </div>

            <!-- ÿ£ŸÉÿ´ÿ± ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ŸÖÿ≥ÿ≠ÿßŸã -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">üèÜ ÿ£ŸÉÿ´ÿ± ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™ ŸÖÿ≥ÿ≠ÿßŸã</h3>
              ${stats.top_scanned.length > 0 ? 
                stats.top_scanned.map((item, index) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div>
                      <span style="font-weight: bold;">#${index + 1}</span>
                      <span style="margin-right: 10px; font-family: monospace;">${item.barcode}</span>
                      <span style="font-size: 0.8rem; opacity: 0.7;">(${item.data_type})</span>
                    </div>
                    <div style="font-weight: bold; color: #00ff88;">${item.scan_count} ŸÖÿ±ÿ©</div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</div>'
              }
            </div>

            <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">üìã ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸàÿπ</h3>
              ${stats.type_breakdown.length > 0 ? 
                stats.type_breakdown.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-weight: bold;">${item.type}</div>
                    <div>
                      <span style="color: #00ff88;">${item.unique_count} ÿ®ÿßÿ±ŸÉŸàÿØ</span>
                      <span style="margin-right: 10px; color: #ffa726;">${item.total_scans} ŸÖÿ≥ÿ≠ÿ©</span>
                    </div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</div>'
              }
            </div>

            <!-- ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">üìÖ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ¢ÿÆÿ± 7 ÿ£ŸäÿßŸÖ</h3>
              ${stats.daily_stats.length > 0 ? 
                stats.daily_stats.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div>${item.date}</div>
                    <div style="color: #00ff88; font-weight: bold;">${item.count} ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ</div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™</div>'
              }
            </div>

            <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ -->
            ${stats.telegram_stats.length > 0 ? `
              <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #4ecdc4;">üì± ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ</h3>
                ${stats.telegram_stats.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-weight: bold;">${item.status === 'success' ? '‚úÖ ŸÜÿßÿ¨ÿ≠' : item.status === 'failed' ? '‚ùå ŸÅÿßÿ¥ŸÑ' : '‚è≥ ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±'}</div>
                    <div>
                      <span style="color: #00ff88;">${item.count} ÿ±ÿ≥ÿßŸÑÿ©</span>
                      ${item.avg_response_time > 0 ? `<span style="margin-right: 10px; color: #ffa726;">${item.avg_response_time}ms</span>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            <!-- ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™ -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">üïí ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÜÿ¥ÿßÿ∑ÿßÿ™</h3>
              ${stats.recent_activities.length > 0 ? 
                stats.recent_activities.slice(0, 10).map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.9rem;">
                    <div>
                      <span style="font-family: monospace; font-weight: bold;">${item.barcode}</span>
                      <span style="margin-right: 8px; opacity: 0.7;">(${item.data_type})</span>
                    </div>
                    <div style="text-align: left;">
                      <div style="color: #00ff88;">${item.scan_count} ŸÖÿ±ÿ©</div>
                      <div style="font-size: 0.8rem; opacity: 0.6;">${item.last_scan}</div>
                    </div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ¥ÿßÿ∑ÿßÿ™</div>'
              }
            </div>

            <!-- ÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ£ÿ∑ŸàÿßŸÑ -->
            ${stats.length_distribution.length > 0 ? `
              <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                <h3 style="margin-bottom: 15px; color: #4ecdc4;">üìè ÿ™Ÿàÿ≤Ÿäÿπ ÿ£ÿ∑ŸàÿßŸÑ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</h3>
                ${stats.length_distribution.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div>${item.length} ÿ±ŸÇŸÖ/ÿ≠ÿ±ŸÅ</div>
                    <div style="color: #00ff88; font-weight: bold;">${item.count} ÿ®ÿßÿ±ŸÉŸàÿØ</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

          </div>
        `;

        console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠");

      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖŸÅÿµŸÑÿ©:", error);
        detailedStatsContent.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <div style="color: #ff6b6b; margin-bottom: 15px; font-size: 3rem;">‚ùå</div>
            <div style="font-size: 1.2rem; margin-bottom: 10px;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</div>
            <div style="opacity: 0.7; margin-bottom: 20px;">${error.message}</div>
            <button onclick="loadDetailedStats()" class="btn" style="background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
              üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
            </button>
          </div>
        `;
      }
    }

    closeModal.addEventListener('click', () => {
      statsModal.style.display = 'none';
    });

    // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿá
    window.addEventListener('click', (event) => {
      if (event.target === statsModal) {
        statsModal.style.display = 'none';
      }
    });

    // ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿπÿ±ÿ∂ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
    async function loadPeriodStats() {
      console.log("üîÑ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
      
      try {
        // ÿπÿ±ÿ∂ loading ÿ£ŸàŸÑÿßŸã
        periodStats.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...
          </div>
        `;

        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ API
        const response = await fetch('/api/detailed-stats');
        if (!response.ok) {
          throw new Error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ: ${response.status}`);
        }

        const data = await response.json();
        
        // ÿ≠ÿ≥ÿßÿ® ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
        const now = new Date();
        const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
        const lastWeekData = Array.from({length: 7}, (_, i) => {
          const date = new Date(now);
          date.setDate(date.getDate() - (i + 7));
          return data.daily_stats.find(d => d.date === date.toISOString().split('T')[0])?.count || 0;
        });
        const lastWeek = lastWeekData.reduce((sum, count) => sum + count, 0);
        
        const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisMonth = data.daily_stats.filter(day => {
          const dayDate = new Date(day.date);
          return dayDate >= thisMonthStart;
        }).reduce((sum, day) => sum + day.count, 0);

        // ÿ≠ÿ≥ÿßÿ® ŸÖÿπÿØŸÑ ÿßŸÑŸÜŸÖŸà
        const weekGrowth = lastWeek > 0 ? ((thisWeek - lastWeek) / lastWeek * 100).toFixed(1) : '0';
        const weekGrowthIcon = weekGrowth > 0 ? 'üìà' : weekGrowth < 0 ? 'üìâ' : '‚ûñ';
        const weekGrowthColor = weekGrowth > 0 ? '#00ff88' : weekGrowth < 0 ? '#ff6b6b' : '#ffa726';

        // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
        periodStats.innerHTML = `
          <div class="db-stats">
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
              <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
            </div>
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: #ff6b6b;">${lastWeek}</div>
              <div class="db-stat-label">ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑŸÖÿßÿ∂Ÿä</div>
            </div>
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
              <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
            </div>
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: ${weekGrowthColor};">${weekGrowth}%</div>
              <div class="db-stat-label">ŸÖÿπÿØŸÑ ÿßŸÑŸÜŸÖŸà ${weekGrowthIcon}</div>
            </div>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
            <h4 style="margin-bottom: 15px; color: #4ecdc4; font-size: 1rem;">üìä ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</h4>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 15px;">
              ${data.daily_stats.slice(-7).map((day, index) => {
                const dayName = new Date(day.date).toLocaleDateString('ar-SA', { weekday: 'short' });
                const isToday = day.date === now.toISOString().split('T')[0];
                const height = Math.max(10, (day.count / Math.max(...data.daily_stats.map(d => d.count)) * 40));
                return `
                  <div style="text-align: center;">
                    <div style="height: 50px; display: flex; align-items: end; justify-content: center;">
                      <div style="
                        width: 20px; 
                        height: ${height}px; 
                        background: ${isToday ? 'linear-gradient(45deg, #ff6b6b, #4ecdc4)' : 'rgba(255,255,255,0.3)'}; 
                        border-radius: 2px 2px 0 0;
                        ${isToday ? 'box-shadow: 0 0 10px rgba(255,107,107,0.5);' : ''}
                        transition: all 0.3s ease;
                      " title="${day.count} ÿ®ÿßÿ±ŸÉŸàÿØ ŸÅŸä ${day.date}"></div>
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px; ${isToday ? 'font-weight: bold; color: #ff6b6b;' : ''}">${dayName}</div>
                    <div style="font-size: 0.8rem; font-weight: bold; color: #00ff88;">${day.count}</div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; opacity: 0.8;">
              <div>üí° ÿßŸÑŸÜŸÖŸà: ${weekGrowth > 0 ? '+' : ''}${weekGrowth}% ŸÖŸÇÿßÿ±ŸÜÿ© ÿ®ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑŸÖÿßÿ∂Ÿä</div>
              <div>üìÖ ${new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
            </div>
          </div>
        `;

        console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠");

      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:", error);
        periodStats.innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <div style="color: #ff6b6b; margin-bottom: 15px; font-size: 2rem;">‚ö†Ô∏è</div>
            <div style="font-size: 1rem; margin-bottom: 10px;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</div>
            <div style="opacity: 0.7; margin-bottom: 20px; font-size: 0.9rem;">${error.message}</div>
            <button onclick="loadPeriodStats()" class="btn info" style="padding: 8px 16px; font-size: 0.9rem;">
              üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
            </button>
          </div>
        `;
      }
    }

    // ==================== ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ ====================
    
    // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
    let fastScanEnabled = true;
    let queueUpdateInterval = null;
    let lastScannedBarcode = null;
    let scanCooldown = false;
    
    // ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸÖŸÜ ÿßŸÑÿ™ŸÉÿ±ÿßÿ± ŸàŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
    async function checkDuplicateAndHandle(code) {
      if (!code || !code.data) return;
      
      const barcode = code.data.trim();
      
      // ŸÖŸÜÿπ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ± ÿßŸÑÿ≥ÿ±Ÿäÿπ
      if (lastScannedBarcode === barcode && scanCooldown) {
        console.log("‚è≥ ŸÖŸÜÿπ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ± ÿßŸÑÿ≥ÿ±Ÿäÿπ");
        return;
      }
      
      try {
        console.log("‚ö° ŸÅÿ≠ÿµ ÿ≥ÿ±Ÿäÿπ ŸÑŸÑÿ™ŸÉÿ±ÿßÿ±:", barcode);
        
        // ÿßÿ≥ÿ™ÿØÿπÿßÿ° API ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ
        const response = await fetch(`/api/check-duplicate/${encodeURIComponent(barcode)}`);
        const duplicateInfo = await response.json();
        
        if (duplicateInfo.is_duplicate) {
          // ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ± - ÿπÿ±ÿ∂ ÿ•ÿ∑ÿßÿ± ÿ£ÿ≠ŸÖÿ± ŸàÿßŸÜÿ®ÿ´ÿßŸÇ
          console.log("üö® ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ± ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅŸá:", barcode);
          
          drawFrame(code.location, "#ff0000", `‚ùå ŸÖŸÉÿ±ÿ± (${duplicateInfo.scan_count}x)`);
          
          // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿ´Ÿäÿ± ŸàŸÖŸäÿ∂ ŸÑŸÑÿ•ÿ∑ÿßÿ± ÿßŸÑÿ£ÿ≠ŸÖÿ±
          setTimeout(() => {
            drawFrame(code.location, "#ff6666", `‚ö†Ô∏è ${duplicateInfo.time_ago}`);
          }, 500);
          
          // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿ∞Ÿäÿ±
          showMessage(`üö® ÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÉÿ±ÿ±: ${barcode} (ÿ™ŸÖ ŸÖÿ≥ÿ≠Ÿá ${duplicateInfo.scan_count} ŸÖÿ±ÿ© - ${duplicateInfo.time_ago})`, "error");
          
          // ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÅŸàÿ±ÿßŸã
          showDuplicateBarcodeImage(barcode);
          
          // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ ŸÉŸÖŸÉÿ±ÿ±
          saveToServer(barcode);
          
        } else {
          // ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ - ŸÖÿπÿßŸÑÿ¨ÿ© ÿπÿßÿØŸäÿ© ŸÖÿπ ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™
          console.log("‚ú® ÿ®ÿßÿ±ŸÉŸàÿØ ÿ¨ÿØŸäÿØ ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅŸá:", barcode);
          
          drawFrame(code.location, "#00ff00", "‚úÖ ÿ¨ÿØŸäÿØ");
          
          // ÿ™ÿ£ÿ´Ÿäÿ± ŸÑŸÖÿπÿßŸÜ ÿßŸÑÿ•ÿ∑ÿßÿ± ÿßŸÑÿ£ÿÆÿ∂ÿ±
          setTimeout(() => {
            drawFrame(code.location, "#00ff88", "üéØ ŸÖÿπÿßŸÑÿ¨ÿ©...");
          }, 300);
          
          // ŸÖÿπÿßŸÑÿ¨ÿ© ÿπÿßÿØŸäÿ©
          handleBarcode(code);
        }
        
        // ÿ™ŸÅÿπŸäŸÑ cooldown ŸÑŸÖŸÜÿπ ÿßŸÑŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±
        lastScannedBarcode = barcode;
        scanCooldown = true;
        setTimeout(() => {
          scanCooldown = false;
        }, 1000); // ÿ´ÿßŸÜŸäÿ© Ÿàÿßÿ≠ÿØÿ© cooldown
        
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ≥ÿ±Ÿäÿπ:", error);
        // fallback ÿ•ŸÑŸâ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿπÿßÿØŸäÿ©
        handleBarcode(code);
      }
    }
    
    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿØÿßŸÑÿ© captureImage ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÖÿπ ÿßŸÑÿ∑ÿßÿ®Ÿàÿ±
    async function captureImageAndQueue(barcode, priority = 'normal') {
      try {
        console.log("üì∏ ÿßŸÑÿ™ŸÇÿßÿ∑ Ÿàÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿßÿ®Ÿàÿ±:", barcode, "ÿ£ŸàŸÑŸàŸäÿ©:", priority);
        
        if (!video.videoWidth || !video.videoHeight) {
          showMessage("‚ö†Ô∏è ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤ÿ©", "warning");
          return false;
        }
        
        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÉÿßŸÜŸÅÿßÿ≥ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        
        // ÿ±ÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©
        ctx.drawImage(video, 0, 0);
        
        // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÜÿµŸàÿµ ŸàÿßŸÑÿ≤ÿÆÿßÿ±ŸÅ
        const now = new Date();
        const arabicDate = now.toLocaleString('ar-IQ', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZone: 'Asia/Baghdad'
        });
        
        // ÿÆŸÑŸÅŸäÿ© ŸÑŸÑŸÜÿµ
        ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
        ctx.fillRect(10, 10, canvas.width - 20, 120);
        
        // ÿßŸÑŸÜÿµŸàÿµ - ÿπÿ±ÿ∂ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÜÿ∏ŸäŸÅ ŸÅŸÇÿ∑
        ctx.font = "bold 20px Cairo";
        ctx.fillStyle = "#00ff88";
        ctx.textAlign = "right";
        
        let displayBarcode = barcode.trim();
        if (displayBarcode.startsWith("00")) {
          displayBarcode = displayBarcode.substring(2);
        }
        
        // ÿπÿ±ÿ∂ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸÜÿ∏ŸäŸÅ ŸÅŸÇÿ∑ ŸÅŸä ÿßŸÑÿµŸàÿ±ÿ©
        ctx.fillText(displayBarcode, canvas.width - 20, 40);
        ctx.fillText(arabicDate, canvas.width - 20, 70);
        ctx.fillText("ŸÖÿßÿ≥ÿ≠ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖÿ™ÿ∑Ÿàÿ± ‚ö°", canvas.width - 20, 100);
        
        // ÿ•ÿ∑ÿßÿ± ÿ≤ÿÆÿ±ŸÅŸä ŸÖÿ™ÿ≠ÿ±ŸÉ
        ctx.strokeStyle = "#00ff88";
        ctx.lineWidth = 4;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        
        // ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ÿµŸàÿ±ÿ©
        const imageDataUrl = canvas.toDataURL("image/jpeg", 0.92);
        
        // ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿßÿ®Ÿàÿ±
        const queueResponse = await fetch('/api/telegram/queue-add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: barcode,
            image_data: imageDataUrl,
            priority: priority
          })
        });
        
        if (queueResponse.ok) {
          const queueResult = await queueResponse.json();
          console.log("üì• ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿßÿ®Ÿàÿ±:", queueResult);
          
          showMessage(`üì§ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿßÿ®Ÿàÿ± (ŸÖŸàÿ∂ÿπ ${queueResult.queue_position})`, "success");
          updateQueueIndicator();
          
          return true;
        } else {
          showMessage("‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ∑ÿßÿ®Ÿàÿ±", "error");
          return false;
        }
        
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸÇÿßÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ŸàÿßŸÑÿ∑ÿßÿ®Ÿàÿ±:", error);
        showMessage("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©", "error");
        return false;
      }
    }
    
    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ∑ÿßÿ®Ÿàÿ±
    async function updateQueueIndicator() {
      try {
        const response = await fetch('/api/telegram/queue-status');
        const queueData = await response.json();
        
        const indicator = document.getElementById('telegram-queue-indicator');
        const countElement = document.getElementById('queue-count');
        const statusElement = document.getElementById('queue-status');
        const progressElement = document.getElementById('queue-progress');
        
        if (queueData.total_items > 0) {
          indicator.style.display = 'block';
          countElement.textContent = queueData.total_items;
          statusElement.textContent = queueData.is_processing ? 'ŸäÿπŸÖŸÑ üîÑ' : 'ŸÖÿ™ŸàŸÇŸÅ ‚è∏Ô∏è';
          statusElement.style.color = queueData.is_processing ? '#00ff88' : '#ffa726';
          
          // ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÇÿØŸÖ
          const progress = queueData.is_processing ? 100 : 0;
          progressElement.style.width = progress + '%';
          
        } else {
          indicator.style.display = 'none';
        }
        
      } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ∑ÿßÿ®Ÿàÿ±:", error);
      }
    }
    
    // ÿØÿßŸÑÿ© ÿ¨ŸÑÿ® ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
    async function fetchBarcodeImage(barcode) {
      try {
        console.log(`üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ: ${barcode}`);
        
        const response = await fetch(`/api/barcode-image/${encodeURIComponent(barcode)}`);
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            console.log(`‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©: ${result.image_path}`);
            return result;
          } else {
            console.log(`‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ: ${barcode}`);
            return null;
          }
        } else {
          console.log(`‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ: ${barcode} (${response.status})`);
          return null;
        }
      } catch (error) {
        console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ${barcode}:`, error);
        return null;
      }
    }
    
    // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
    async function showDuplicateBarcodeImage(barcode) {
      const modal = document.getElementById('duplicate-image-modal');
      const barcodeElement = document.getElementById('duplicate-barcode');
      const detailsElement = document.getElementById('duplicate-details');
      const imageContainer = document.getElementById('duplicate-image-container');
      
      if (!modal || !barcodeElement || !detailsElement || !imageContainer) {
        console.error("‚ùå ÿπŸÜÿßÿµÿ± modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
        return;
      }
      
      // ÿ•ÿπÿØÿßÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
      barcodeElement.textContent = barcode;
      detailsElement.textContent = "ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÜ ŸÇÿ®ŸÑ";
      
      // ÿπÿ±ÿ∂ loading
      imageContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©...
        </div>
      `;
      
      // ÿπÿ±ÿ∂ ÿßŸÑŸÄ modal
      modal.style.display = 'block';
      
      // ÿ¨ŸÑÿ® ÿßŸÑÿµŸàÿ±ÿ©
      const imageData = await fetchBarcodeImage(barcode);
      
      if (imageData) {
        imageContainer.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong>ÿ¢ÿÆÿ± ÿ•ÿ±ÿ≥ÿßŸÑ:</strong> ${new Date(imageData.created_at).toLocaleString('ar-SA')}
          </div>
          <img src="${imageData.image_url}" 
               alt="ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ${barcode}" 
               style="
                 max-width: 100%; 
                 max-height: 400px; 
                 border-radius: 10px;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                 border: 2px solid #ffa726;
               "
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div style="display: none; color: #ff6b6b; text-align: center; padding: 20px;">
            ‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©
          </div>
        `;
        
        detailsElement.innerHTML = `
          <div style="margin-bottom: 10px;">
            ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ≥ÿßÿ®ŸÇÿßŸã
          </div>
          <div style="font-size: 0.9rem; opacity: 0.8;">
            ÿßŸÑÿ≠ÿßŸÑÿ©: <span style="color: ${imageData.status === 'success' ? '#00ff88' : '#ff6b6b'};">
              ${imageData.status === 'success' ? 'ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠' : 'ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ'}
            </span>
          </div>
        `;
      } else {
        imageContainer.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b6b;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üì∑</div>
            <div style="margin-bottom: 10px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©</div>
            <div style="font-size: 0.9rem; opacity: 0.7;">
              ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ™ŸÖ ŸÖÿ≥ÿ≠Ÿá ŸÖŸÜ ŸÇÿ®ŸÑ ŸÑŸÉŸÜ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸá
            </div>
          </div>
        `;
        
        detailsElement.textContent = "ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÜ ŸÇÿ®ŸÑÿå ŸÑŸÉŸÜ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©";
      }
    }
    
    // Event listeners ŸÑŸÄ modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('duplicate-image-modal');
      const closeBtn = document.querySelector('.duplicate-close');
      const closeModalBtn = document.getElementById('close-duplicate-modal');
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ X
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
      if (modal) {
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ Escape
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });
    });
  </script>

  <!-- ÿ•ÿµŸÑÿßÿ≠ ŸÅŸàÿ±Ÿä ŸÑŸÖÿ¥ŸÉŸÑÿ© ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© -->
  <script>
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ∂ÿßŸÅŸä ŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
    document.addEventListener('DOMContentLoaded', () => {
      console.log("üîß ÿ®ÿØÿ° ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
      
      // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑ ÿ´ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿØÿßŸÑÿ©
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement) {
          console.log("‚úÖ ÿπŸÜÿµÿ± period-stats ŸÖŸàÿ¨ŸàÿØ");
          
          // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿØÿßŸÑÿ© Ÿàÿßÿ≥ÿ™ÿØÿπÿßÿ§Ÿáÿß
          if (typeof loadPeriodStats === 'function') {
            console.log("‚úÖ ÿØÿßŸÑÿ© loadPeriodStats ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿØÿπÿßÿ§Ÿáÿß...");
            loadPeriodStats();
          } else {
            console.error("‚ùå ÿØÿßŸÑÿ© loadPeriodStats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿØÿßŸÑÿ© ÿ®ÿØŸäŸÑÿ©
            window.loadPeriodStats = async function() {
              try {
                periodStatsElement.innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...
                  </div>
                `;
                
                const response = await fetch('/api/detailed-stats');
                const data = await response.json();
                
                const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
                const thisMonth = data.daily_stats.filter(day => {
                  const dayDate = new Date(day.date);
                  const thisMonthStart = new Date();
                  thisMonthStart.setDate(1);
                  return dayDate >= thisMonthStart;
                }).reduce((sum, day) => sum + day.count, 0);
                
                periodStatsElement.innerHTML = `
                  <div class="db-stats">
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                      <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                      <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                      <div class="db-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                      <div class="db-stat-label">ŸÖÿπÿØŸÑ ÿßŸÑŸÜŸÖŸà üìä</div>
                    </div>
                  </div>
                `;
                console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠");
              } catch (error) {
                console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:", error);
                periodStatsElement.innerHTML = `
                  <div style="text-align: center; padding: 30px;">
                    <div style="color: #ff6b6b;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</div>
                    <button onclick="loadPeriodStats()" class="btn info" style="margin-top: 10px;">üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
                  </div>
                `;
              }
            };
            
            // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ®ÿØŸäŸÑÿ©
            loadPeriodStats();
          }
        } else {
          console.error("‚ùå ÿπŸÜÿµÿ± period-stats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");
        }
      }, 3000);
      
      // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜ
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement && periodStatsElement.innerHTML.includes("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ")) {
          console.log("üîÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
          if (typeof loadPeriodStats === 'function') {
            loadPeriodStats();
          }
        }
      }, 10000);
    });
  </script>

  <!-- ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage (ÿ®ÿµŸÖÿ™) -->
  <script>
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ∂ÿßŸÅŸä ŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
    document.addEventListener('DOMContentLoaded', () => {
      console.log("üîß ÿ®ÿØÿ° ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
      
      // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑ ÿ´ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿØÿßŸÑÿ©
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement) {
          console.log("‚úÖ ÿπŸÜÿµÿ± period-stats ŸÖŸàÿ¨ŸàÿØ");
          
          // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿØÿßŸÑÿ© Ÿàÿßÿ≥ÿ™ÿØÿπÿßÿ§Ÿáÿß
          if (typeof loadPeriodStats === 'function') {
            console.log("‚úÖ ÿØÿßŸÑÿ© loadPeriodStats ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿØÿπÿßÿ§Ÿáÿß...");
            loadPeriodStats();
          } else {
            console.error("‚ùå ÿØÿßŸÑÿ© loadPeriodStats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿØÿßŸÑÿ© ÿ®ÿØŸäŸÑÿ©
            window.loadPeriodStats = async function() {
              try {
                periodStatsElement.innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...
                  </div>
                `;
                
                const response = await fetch('/api/detailed-stats');
                const data = await response.json();
                
                const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
                const thisMonth = data.daily_stats.filter(day => {
                  const dayDate = new Date(day.date);
                  const thisMonthStart = new Date();
                  thisMonthStart.setDate(1);
                  return dayDate >= thisMonthStart;
                }).reduce((sum, day) => sum + day.count, 0);
                
                periodStatsElement.innerHTML = `
                  <div class="db-stats">
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                      <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                      <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                      <div class="db-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                      <div class="db-stat-label">ŸÖÿπÿØŸÑ ÿßŸÑŸÜŸÖŸà üìä</div>
                    </div>
                  </div>
                `;
                console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠");
              } catch (error) {
                console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:", error);
                periodStatsElement.innerHTML = `
                  <div style="text-align: center; padding: 30px;">
                    <div style="color: #ff6b6b;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</div>
                    <button onclick="loadPeriodStats()" class="btn info" style="margin-top: 10px;">üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
                  </div>
                `;
              }
            };
            
            // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ®ÿØŸäŸÑÿ©
            loadPeriodStats();
          }
        } else {
          console.error("‚ùå ÿπŸÜÿµÿ± period-stats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");
        }
      }, 3000);
      
      // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜ
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement && periodStatsElement.innerHTML.includes("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ")) {
          console.log("üîÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
          if (typeof loadPeriodStats === 'function') {
            loadPeriodStats();
          }
        }
      }, 10000);
    });
  </script>

  <!-- ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage (ÿ®ÿµŸÖÿ™) -->
  <script>
    // ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ∂ÿßŸÅŸä ŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
    document.addEventListener('DOMContentLoaded', () => {
      console.log("üîß ÿ®ÿØÿ° ÿ•ÿµŸÑÿßÿ≠ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
      
      // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑ ÿ´ŸÖ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿØÿßŸÑÿ©
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement) {
          console.log("‚úÖ ÿπŸÜÿµÿ± period-stats ŸÖŸàÿ¨ŸàÿØ");
          
          // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿØÿßŸÑÿ© Ÿàÿßÿ≥ÿ™ÿØÿπÿßÿ§Ÿáÿß
          if (typeof loadPeriodStats === 'function') {
            console.log("‚úÖ ÿØÿßŸÑÿ© loadPeriodStats ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿØÿπÿßÿ§Ÿáÿß...");
            loadPeriodStats();
          } else {
            console.error("‚ùå ÿØÿßŸÑÿ© loadPeriodStats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
            
            // ÿ•ŸÜÿ¥ÿßÿ° ÿØÿßŸÑÿ© ÿ®ÿØŸäŸÑÿ©
            window.loadPeriodStats = async function() {
              try {
                periodStatsElement.innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...
                  </div>
                `;
                
                const response = await fetch('/api/detailed-stats');
                const data = await response.json();
                
                const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
                const thisMonth = data.daily_stats.filter(day => {
                  const dayDate = new Date(day.date);
                  const thisMonthStart = new Date();
                  thisMonthStart.setDate(1);
                  return dayDate >= thisMonthStart;
                }).reduce((sum, day) => sum + day.count, 0);
                
                periodStatsElement.innerHTML = `
                  <div class="db-stats">
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                      <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                      <div class="db-stat-label">Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                      <div class="db-stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØÿßÿ™</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                      <div class="db-stat-label">ŸÖÿπÿØŸÑ ÿßŸÑŸÜŸÖŸà üìä</div>
                    </div>
                  </div>
                `;
                console.log("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠");
              } catch (error) {
                console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©:", error);
                periodStatsElement.innerHTML = `
                  <div style="text-align: center; padding: 30px;">
                    <div style="color: #ff6b6b;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</div>
                    <button onclick="loadPeriodStats()" class="btn info" style="margin-top: 10px;">üîÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
                  </div>
                `;
              }
            };
            
            // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ®ÿØŸäŸÑÿ©
            loadPeriodStats();
          }
        } else {
          console.error("‚ùå ÿπŸÜÿµÿ± period-stats ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ");
        }
      }, 3000);
      
      // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≠ÿßŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜ
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement && periodStatsElement.innerHTML.includes("ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ")) {
          console.log("üîÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...");
          if (typeof loadPeriodStats === 'function') {
            loadPeriodStats();
          }
        }
      }, 10000);
    });
  </script>

  <!-- ÿØŸàÿßŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© -->
  <script>
    // ÿØÿßŸÑÿ© ÿ¨ŸÑÿ® ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿßŸÑŸÖŸÉÿ±ÿ±
    async function fetchBarcodeImage(barcode) {
      try {
        console.log(`üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ: ${barcode}`);
        
        const response = await fetch(`/api/barcode-image/${encodeURIComponent(barcode)}`);
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            console.log(`‚úÖ ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©: ${result.image_path}`);
            return result;
          } else {
            console.log(`‚ÑπÔ∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ: ${barcode}`);
            return null;
          }
        } else {
          console.log(`‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿµŸàÿ±ÿ© ŸÑŸÑÿ®ÿßÿ±ŸÉŸàÿØ: ${barcode} (${response.status})`);
          return null;
        }
      } catch (error) {
        console.error(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ¨ŸÑÿ® ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ${barcode}:`, error);
        return null;
      }
    }
    
    // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
    async function showDuplicateBarcodeImage(barcode) {
      const modal = document.getElementById('duplicate-image-modal');
      const barcodeElement = document.getElementById('duplicate-barcode');
      const detailsElement = document.getElementById('duplicate-details');
      const imageContainer = document.getElementById('duplicate-image-container');
      
      if (!modal || !barcodeElement || !detailsElement || !imageContainer) {
        console.error("‚ùå ÿπŸÜÿßÿµÿ± modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
        return;
      }
      
      // ÿ•ÿπÿØÿßÿØ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ
      barcodeElement.textContent = barcode;
      detailsElement.textContent = "ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÜ ŸÇÿ®ŸÑ";
      
      // ÿπÿ±ÿ∂ loading
      imageContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©...
        </div>
      `;
      
      // ÿπÿ±ÿ∂ ÿßŸÑŸÄ modal
      modal.style.display = 'block';
      
      // ÿ¨ŸÑÿ® ÿßŸÑÿµŸàÿ±ÿ©
      const imageData = await fetchBarcodeImage(barcode);
      
      if (imageData) {
        imageContainer.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong>ÿ¢ÿÆÿ± ÿ•ÿ±ÿ≥ÿßŸÑ:</strong> ${new Date(imageData.created_at).toLocaleString('ar-SA')}
          </div>
          <img src="${imageData.image_url}" 
               alt="ÿµŸàÿ±ÿ© ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ${barcode}" 
               style="
                 max-width: 100%; 
                 max-height: 400px; 
                 border-radius: 10px;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                 border: 2px solid #ffa726;
               "
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div style="display: none; color: #ff6b6b; text-align: center; padding: 20px;">
            ‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©
          </div>
        `;
        
        detailsElement.innerHTML = `
          <div style="margin-bottom: 10px;">
            ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ≥ÿßÿ®ŸÇÿßŸã
          </div>
          <div style="font-size: 0.9rem; opacity: 0.8;">
            ÿßŸÑÿ≠ÿßŸÑÿ©: <span style="color: ${imageData.status === 'success' ? '#00ff88' : '#ff6b6b'};">
              ${imageData.status === 'success' ? 'ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ŸÜÿ¨ÿßÿ≠' : 'ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ'}
            </span>
          </div>
        `;
      } else {
        imageContainer.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b6b;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üì∑</div>
            <div style="margin-bottom: 10px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©</div>
            <div style="font-size: 0.9rem; opacity: 0.7;">
              ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ÿ™ŸÖ ŸÖÿ≥ÿ≠Ÿá ŸÖŸÜ ŸÇÿ®ŸÑ ŸÑŸÉŸÜ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑŸá
            </div>
          </div>
        `;
        
        detailsElement.textContent = "ÿ™ŸÖ ŸÖÿ≥ÿ≠ Ÿáÿ∞ÿß ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ ŸÖŸÜ ŸÇÿ®ŸÑÿå ŸÑŸÉŸÜ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ©";
      }
    }
    
    // Event listeners ŸÑŸÄ modal ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÉÿ±ÿ±ÿ©
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('duplicate-image-modal');
      const closeBtn = document.querySelector('.duplicate-close');
      const closeModalBtn = document.getElementById('close-duplicate-modal');
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ X
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
      if (modal) {
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }
      
      // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÄ modal ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ Escape
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
