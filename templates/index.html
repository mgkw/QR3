<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø¨ÙˆÙ†Ø¬ÙŠ ÙƒØ±ÙˆØ¨</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
      background-size: 400% 400%;
      animation: gradientText 3s ease infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(255,255,255,0.5);
      margin-bottom: 15px;
      transform: perspective(1000px) rotateX(15deg);
    }

    @keyframes gradientText {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .camera-container {
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      margin-bottom: 30px;
    }

    .video-wrapper {
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    #video {
      width: 100%;
      max-width: 600px;
      height: auto;
      display: block;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .scanner-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff88, transparent);
      animation: scan 2s linear infinite;
    }

    @keyframes scan {
      0% { transform: translateY(0); }
      100% { transform: translateY(300px); }
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .btn.flash-on {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    }

    .btn.flash-off {
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
    }

    .btn.danger {
      background: linear-gradient(135deg, #ff4757, #c44569);
    }

    .btn.info {
      background: linear-gradient(135deg, #3742fa, #2f3542);
    }

    .main-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      width: 100%;
      max-width: 1200px;
      margin-top: 30px;
    }

    .stats-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .stats-card h3 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .stats-card .icon {
      font-size: 1.5rem;
    }

    .barcode-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 15px;
      margin: 8px 0;
      border-radius: 8px;
      border-left: 4px solid #00ff88;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }

    .barcode-item.repeated {
      border-left-color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
    }

    .db-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .db-stat-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .db-stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #00ff88;
    }

    .db-stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 5px;
    }

    .status-message {
      position: fixed;
      top: 30px;
      right: 30px;
      z-index: 1000;
      max-width: 300px;
    }

    .message {
      background: rgba(0, 0, 0, 0.9);
      color: #00ff88;
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: translateX(100%);
      animation: slideIn 0.3s ease forwards;
    }

    .message.error {
      color: #ff6b6b;
    }

    .message.warning {
      color: #ffa726;
    }

    @keyframes slideIn {
      to { transform: translateX(0); }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #ffffff;
      font-weight: 600;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .management-section {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 10% auto;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
    }

    .close {
      color: #aaa;
      float: left;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: white;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      
      .camera-container {
        margin: 0 10px;
      }
      
      .controls {
        flex-direction: column;
        align-items: center;
      }
      
      .btn {
        width: 200px;
      }

      .main-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø¨ÙˆÙ†Ø¬ÙŠ ÙƒØ±ÙˆØ¨</h1>
    <p>ÙÙ‚Ø·</p>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
  <div style="
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.2);
    text-align: center;
  ">
    <a href="/" style="
      display: inline-block;
      margin: 8px 12px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #4ecdc4, #44a08d);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
      ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </a>
    
    <a href="/telegram-monitor" style="
      display: inline-block;
      margin: 8px 12px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
      ğŸ¤– Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    </a>
    
    <a href="/stats" style="
      display: inline-block;
      margin: 8px 12px;
      padding: 12px 25px;
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: white;
      text-decoration: none;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
       onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
      ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    </a>
  </div>

  <div class="camera-container">
    <div class="video-wrapper">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
      <div class="scanner-line"></div>
    </div>
    
    <div class="controls">
      <button id="flash-toggle" class="btn flash-off">ğŸ”¦ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´</button>
      <button id="camera-switch" class="btn">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="restart-app" class="btn info">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
    </div>
  </div>

  <div class="main-container">
    <div class="stats-card">
      <h3>
        <span class="icon">âœ…</span>
        Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      </h3>
      <div id="new-barcodes-list">
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
      </div>
    </div>
    
    <div class="stats-card">
      <h3>
        <span class="icon">âš ï¸</span>
        Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
      </h3>
      <div id="repeated-barcodes-list">
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
      </div>
    </div>

    <div class="stats-card">
      <h3>
        <span class="icon">ğŸ“Š</span>
        Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      </h3>
      <div id="database-stats">
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
      </div>
      
      <div class="management-section">
        <button id="refresh-stats" class="btn info">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
        <button id="view-detailed-stats" class="btn info">ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©</button>
      </div>
    </div>

    <div class="stats-card">
      <h3>
        <span class="icon">ğŸ“ˆ</span>
        Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
      </h3>
      <div id="period-stats">
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
      </div>
    </div>
  </div>

  <div id="status-messages" class="status-message"></div>

  <!-- Modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <div id="duplicate-image-modal" class="modal" style="display: none;">
    <div class="modal-content" style="
      max-width: 600px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      border: 3px solid #fff;
      box-shadow: 0 20px 60px rgba(255,107,107,0.4);
      animation: modalBounce 0.3s ease-out;
    ">
      <span class="duplicate-close" style="
        color: #fff;
        float: left;
        font-size: 32px;
        font-weight: bold;
        cursor: pointer;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">&times;</span>
      
      <div style="text-align: center; padding: 10px 0;">
        <h2 style="
          color: white;
          margin-bottom: 20px;
          text-shadow: 0 2px 4px rgba(0,0,0,0.3);
          font-size: 1.8rem;
          animation: pulse 2s infinite;
        ">âš ï¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø±!</h2>
        
        <div style="
          background: rgba(255,255,255,0.1);
          border-radius: 15px;
          padding: 20px;
          margin-bottom: 20px;
          backdrop-filter: blur(10px);
        ">
          <div style="
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
          ">
            Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: <span id="duplicate-barcode" style="color: #ffeb3b;">-</span>
          </div>
          
          <div id="duplicate-details" style="
            color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
            font-size: 1rem;
          ">
            ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„
          </div>
          
          <div id="duplicate-image-container" style="
            min-height: 200px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
          ">
            <div class="loading">
              <div class="spinner"></div>
              Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...
            </div>
          </div>
        </div>
        
        <button id="close-duplicate-modal" style="
          background: linear-gradient(135deg, #4ecdc4, #44a08d);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 25px;
          font-size: 1rem;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)'" 
           onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)'">
          ğŸ”„ Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¢Ø®Ø±
        </button>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ø¨ÙˆØ± -->
  <div id="telegram-queue-indicator" style="
    position: fixed;
    top: 100px;
    right: 30px;
    z-index: 1500;
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    min-width: 200px;
    display: none;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
  ">
    <div style="font-weight: bold; margin-bottom: 10px; color: #4ecdc4;">ğŸ“¤ Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</div>
    <div id="queue-stats">
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:</span>
        <span id="queue-count" style="color: #00ff88;">0</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span>
        <span id="queue-status" style="color: #ffa726;">Ù…ØªÙˆÙ‚Ù</span>
      </div>
      <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; margin-top: 10px;">
        <div id="queue-progress" style="height: 100%; background: linear-gradient(90deg, #4ecdc4, #00ff88); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
      </div>
    </div>
  </div>

  <!-- Ù…Ø¤Ø´Ø± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… -->
  <div id="performance-indicator" class="fps-indicator" style="display: none;">
    <div id="fps-display">FPS: --</div>
    <div style="font-size: 0.7rem; opacity: 0.8;">âš¡ Ù…ØªØ·ÙˆØ± v2.0</div>
  </div>

  <style>
  @keyframes modalBounce {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }
  
  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ·ÙˆØ± */
  .duplicate-close {
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }
  
  .duplicate-close:hover {
    color: #ffeb3b !important;
    text-shadow: 0 0 10px rgba(255, 235, 59, 0.8);
  }
  
  #telegram-queue-indicator {
    animation: slideInFromRight 0.5s ease-out;
  }
  
  @keyframes slideInFromRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ */
  #overlay {
    will-change: transform;
    backface-visibility: hidden;
    perspective: 1000px;
  }
  
  #video {
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡ */
  .fps-indicator {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.8);
    color: #00ff88;
    padding: 5px 10px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    z-index: 1000;
    border: 1px solid rgba(0, 255, 136, 0.3);
  }
  </style>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø© -->
  <div id="stats-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©</h2>
      <div id="detailed-stats-content">
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©...
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
  <div id="reset-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
      <p>âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ!</p>
      <br>
      <div style="display: flex; gap: 15px; justify-content: center;">
        <button id="confirm-reset" class="btn danger">Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡</button>
        <button id="cancel-reset" class="btn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
  <audio id="beep-sound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp3a1VEhFOre7UjGMSENb6" type="audio/wav">
  </audio>

  <!-- Ù…ÙƒØªØ¨Ø© jsQR Ù„Ù„Ù€ QR Codes -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  
  <!-- Ù…ÙƒØªØ¨Ø© QuaggaJS Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  
  <!-- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ù…Ø­Ø³Ù† -->
  <script src="/static/duplicate-image.js"></script>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    const botToken = "7668051564:AAFdFqSd0CKrlSOyPKyFwf-xHi791lcsC_U";
    const chatId = -1002439956600; console.log("?? ??????? ????????? ????? - Token:", !!botToken, "ChatId:", !!chatId);
    
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const context = overlay.getContext("2d");
    const beepSound = document.getElementById("beep-sound");
  const flashToggle = document.getElementById("flash-toggle");
    const cameraSwitch = document.getElementById("camera-switch");
    const statusMessages = document.getElementById("status-messages");
    const newBarcodesList = document.getElementById("new-barcodes-list");
    const repeatedBarcodesList = document.getElementById("repeated-barcodes-list");
    const databaseStats = document.getElementById("database-stats");
    const periodStats = document.getElementById("period-stats");
    const refreshStatsBtn = document.getElementById("refresh-stats");
    const viewDetailedStatsBtn = document.getElementById("view-detailed-stats");
    const statsModal = document.getElementById("stats-modal");
    const detailedStatsContent = document.getElementById("detailed-stats-content");
    const restartAppBtn = document.getElementById("restart-app");
    const closeModal = document.querySelector(".close");

    // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let currentStream = null;
    let currentTrack = null;
  let flashEnabled = false;
    let isScanning = false;
    let cameras = [];
    let currentCameraIndex = 0;

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
  let barcodeDatabase = new Set();
  let barcodeTimes = {};
  let repeatedBarcodes = new Set();
    let newBarcodes = [];

    // Ø¥ØµÙ„Ø§Ø­ ÙÙˆØ±ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    setTimeout(() => {
      console.log("ğŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
      
      const periodStatsElement = document.getElementById("period-stats");
      if (!periodStatsElement) {
        console.error("âŒ Ø¹Ù†ØµØ± period-stats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        return;
      }
      
      // Ø¯Ø§Ù„Ø© Ø¥ØµÙ„Ø§Ø­ Ø¨Ø¯ÙŠÙ„Ø©
      async function fixPeriodStatsDisplay() {
        try {
          periodStatsElement.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...
            </div>
          `;
          
          const response = await fetch('/api/detailed-stats');
          if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
          }
          
          const data = await response.json();
          console.log("ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:", data);
          
          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
          const thisMonth = data.daily_stats.filter(day => {
            const dayDate = new Date(day.date);
            const thisMonthStart = new Date();
            thisMonthStart.setDate(1);
            return dayDate >= thisMonthStart;
          }).reduce((sum, day) => sum + day.count, 0);
          
          // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
          periodStatsElement.innerHTML = `
            <div class="db-stats">
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
              </div>
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
              </div>
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                <div class="db-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</div>
              </div>
              <div class="db-stat-item">
                <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                <div class="db-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ ğŸ“Š</div>
              </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
              <div style="font-size: 0.9rem; opacity: 0.8;">
                ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${new Date().toLocaleString('ar-SA')}
              </div>
            </div>
          `;
          
          console.log("âœ… ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
          
        } catch (error) {
          console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­:", error);
          periodStatsElement.innerHTML = `
            <div style="text-align: center; padding: 30px;">
              <div style="color: #ff6b6b;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
              <button onclick="fixPeriodStatsDisplay()" class="btn info" style="margin-top: 10px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
            </div>
          `;
        }
      }
      
      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­
      fixPeriodStatsDisplay();
      
      // Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
      window.fixPeriodStatsDisplay = fixPeriodStatsDisplay;
      
    }, 5000); // ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage (Ø¨ØµÙ…Øª)
    function loadLocalData() {
      try {
        const stored = localStorage.getItem('barcodeData');
        if (stored) {
          const data = JSON.parse(stored);
          barcodeDatabase = new Set(data.barcodes || []);
          barcodeTimes = data.times || {};
          repeatedBarcodes = new Set(data.repeated || []);
          newBarcodes = data.newBarcodes || [];
          console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage");
        }
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
      }
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ù…Ø¹ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©
    function showMessage(message, type = "success", duration = 4000) {
      // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©
      if (message.includes("ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª") || 
          message.includes("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„") || 
          message.includes("ØªÙ‡ÙŠØ¦Ø©") ||
          message.includes("Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«") ||
          message.includes("ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§") ||
          message.includes("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª") ||
          message.includes("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ«") ||
          message.includes("ØªÙ… ØªØ­Ø¯ÙŠØ«") ||
          message.includes("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„") ||
          message.includes("Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„") ||
          message.includes("Ø§Ù„Ù†ØµØ§Ø¦Ø­")) {
        return; // ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      }

      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      statusMessages.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, duration);
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
    function saveLocalData() {
      try {
    const data = {
      barcodes: Array.from(barcodeDatabase),
      times: barcodeTimes,
          repeated: Array.from(repeatedBarcodes),
          newBarcodes: newBarcodes
    };
    localStorage.setItem('barcodeData', JSON.stringify(data));
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
      }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª
    async function getCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(device => device.kind === 'videoinput');
        console.log("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©:", cameras.length);
        
        if (cameras.length > 1) {
          cameraSwitch.style.display = 'block';
        }
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª:", error);
      }
    }

    // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ø²Ø§Ø¦Ø¯Ø©)
    async function startCamera(deviceId = null) {
      try {
        console.log("ğŸ¬ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...");
        
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
          currentTrack = null;
        }

        const constraints = {
          video: {
            facingMode: deviceId ? undefined : "environment",
            width: { ideal: 1920, min: 640 },
            height: { ideal: 1080, min: 480 },
            frameRate: { ideal: 30, min: 15 },
            focusMode: "continuous",
            exposureMode: "continuous",
            whiteBalanceMode: "continuous"
          }
        };

        if (deviceId) {
          constraints.video.deviceId = { exact: deviceId };
        }

        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = currentStream;
        currentTrack = currentStream.getVideoTracks()[0];
        
        console.log("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
        
        video.onloadedmetadata = () => {
          console.log("ğŸ“º ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
          
          video.play().then(() => {
            console.log("â–¶ï¸ Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ");
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            
            setTimeout(() => {
              if (!isScanning) {
                startScanning();
              }
            }, 1000);
            
          }).catch(error => {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:", error);
            showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", "error");
          });
        };

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", error);
        
        let errorMessage = "ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
        if (error.name === 'NotAllowedError') {
          errorMessage = "ØªÙ… Ø±ÙØ¶ Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
        } else if (error.name === 'NotFoundError') {
          errorMessage = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø²";
        }
        
        showMessage("âŒ " + errorMessage, "error");
      }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´ (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ø²Ø§Ø¦Ø¯Ø©)
    flashToggle.addEventListener("click", async () => {
      if (!currentTrack) return;

      try {
        const capabilities = currentTrack.getCapabilities();
        if (capabilities.torch) {
          flashEnabled = !flashEnabled;
          await currentTrack.applyConstraints({
            advanced: [{ torch: flashEnabled }]
          });
          
          flashToggle.textContent = flashEnabled ? "ğŸ”¦ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´" : "ğŸ”¦ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´";
          flashToggle.className = flashEnabled ? "btn flash-on" : "btn flash-off";
          
          // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§Ø´
        } else {
          showMessage("âŒ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙ„Ø§Ø´", "error");
        }
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´", "error");
      }
    });

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ø²Ø§Ø¦Ø¯Ø©)
    cameraSwitch.addEventListener("click", () => {
      if (cameras.length > 1) {
        currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
        startCamera(cameras[currentCameraIndex].deviceId);
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      }
    });

    // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function updateLists() {
      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      if (newBarcodes.length === 0) {
        newBarcodesList.innerHTML = '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>';
      } else {
        newBarcodesList.innerHTML = newBarcodes.slice(-5).reverse().map(barcode => 
          `<div class="barcode-item">${barcode}</div>`
        ).join('');
      }

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
      const repeatedArray = Array.from(repeatedBarcodes);
      if (repeatedArray.length === 0) {
        repeatedBarcodesList.innerHTML = '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ù…ÙƒØ±Ø±Ø©</div>';
      } else {
        repeatedBarcodesList.innerHTML = repeatedArray.slice(-5).reverse().map(barcode => 
          `<div class="barcode-item repeated">${barcode}</div>`
        ).join('');
      }
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    async function saveToServer(barcode) {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (!barcode || barcode.trim() === '') {
          console.warn("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø±Øº ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…");
          return { success: false, isDuplicate: false };
        }

        const cleanBarcode = barcode.trim();
        
        if (cleanBarcode.length < 1 || cleanBarcode.length > 100) {
          console.warn("âš ï¸ Ø·ÙˆÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø­ÙØ¸:", cleanBarcode);
          return { success: false, isDuplicate: false };
        }

        console.log("ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:", cleanBarcode);

        const response = await fetch("/add_barcode", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ barcode: cleanBarcode })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
          console.log("ğŸ“ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:", result);
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±
          if (result.is_duplicate) {
            const duplicateInfo = {
              barcode: result.barcode,
              scan_number: result.scan_number,
              last_scan_datetime: result.last_scan_datetime,
              time_ago: result.time_ago,
              total_scans: result.total_scans
            };
            
            console.log("ğŸ”„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø± - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:", duplicateInfo);
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙØµÙŠÙ„ÙŠØ© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±
            const duplicateMessage = `ğŸ”„ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø±: ${result.barcode}\n` +
                                   `ğŸ“Š Ø§Ù„Ù…Ø³Ø­ Ø±Ù‚Ù…: ${result.scan_number}\n` +
                                   `â° Ø¢Ø®Ø± Ù…Ø³Ø­: ${result.time_ago}\n` +
                                   `ğŸ“ˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­Ø§Øª: ${result.total_scans}`;
            
            showMessage(duplicateMessage, "warning", 8000); // Ø¹Ø±Ø¶ Ù„Ù…Ø¯Ø© 8 Ø«ÙˆØ§Ù†
            
            return { 
              success: true, 
              isDuplicate: true, 
              duplicateInfo: duplicateInfo,
              result: result
            };
          } else {
            // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
            console.log("âœ¨ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø­ÙØ¸Ù‡");
            showMessage(`âœ… ØªÙ… Ø­ÙØ¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯: ${result.barcode}`, "success");
            
            return { 
              success: true, 
              isDuplicate: false,
              result: result
            };
          }
        } else {
          const errorText = await response.text();
          console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:");
          console.error("ğŸ“„ ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£:", response.status);
          console.error("ğŸ“„ Ù†Øµ Ø§Ù„Ø®Ø·Ø£:", errorText);
          
          if (response.status === 400) {
            showMessage("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "error");
          } else if (response.status === 500) {
            showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
          } else {
            showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯", "error");
          }
          
          return { success: false, isDuplicate: false };
        }
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          console.error("ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©");
          showMessage("âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©", "error");
        } else {
          showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯", "error");
        }
        
        return { success: false, isDuplicate: false };
      }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø³Ø·Ø©
    async function sendToTelegram(barcode, imageData, caption) {
      if (!botToken || !chatId) {
        console.error("âŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©");
        showMessage("âŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©", "error");
        return false;
      }

      const startTime = Date.now();
      let messageId = null;

      try {
        // ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        const response = await fetch('/api/telegram/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: barcode,
            status: 'pending',
            chat_id: chatId,
            caption: caption,
            data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed'
          })
        });

        if (response.ok) {
          const result = await response.json();
          messageId = result.message_id;
        }

        // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        const blob = await (await fetch(imageData)).blob();
        const file = new File([blob], `barcode_${barcode}.jpg`, { type: 'image/jpeg' });

        const formData = new FormData();
        formData.append('photo', file);
        formData.append('chat_id', chatId);
        if (caption) {
          formData.append('caption', caption);
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        const telegramResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
          method: 'POST',
          body: formData
        });

        const responseTime = Date.now() - startTime;
        const telegramResult = await telegramResponse.json();

        if (telegramResponse.ok && telegramResult.ok) {
          // Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
          let imagePath = null;
          try {
            const saveImageResponse = await fetch('/api/telegram/upload-image', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                barcode: barcode,
                image_data: imageData
              })
            });
            
            if (saveImageResponse.ok) {
              const saveResult = await saveImageResponse.json();
              imagePath = saveResult.filename;
              console.log(`ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©: ${imagePath}`);
            } else {
              console.warn("âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹");
            }
          } catch (saveError) {
            console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹:", saveError);
          }

          // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ù…Ø³Ø§Ø± Ø§Ù„ØµÙˆØ±Ø©
          await fetch('/api/telegram/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              barcode: barcode,
              status: 'success',
              message_id: telegramResult.result.message_id.toString(),
              chat_id: chatId,
              caption: caption,
              image_size: blob.size,
              response_time: responseTime,
              data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed',
              image_path: imagePath
            })
          });

          showMessage("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "success");
          console.log(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${barcode} Ø¥Ù„Ù‰ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­`);
          return true;

        } else {
          // ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          const errorMessage = telegramResult.description || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
          
          await fetch('/api/telegram/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              barcode: barcode,
              status: 'failed',
              error_code: telegramResult.error_code?.toString(),
              error_message: errorMessage,
              response_time: responseTime,
              chat_id: chatId,
              caption: caption,
              data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed'
            })
          });

          console.error(`âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ ${barcode}:`, errorMessage);
          showMessage("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "error");
          return false;
        }

      } catch (error) {
        const responseTime = Date.now() - startTime;
        
        // ØªØ³Ø¬ÙŠÙ„ Ø®Ø·Ø£ Ø§Ù„Ø´Ø¨ÙƒØ©
        await fetch('/api/telegram/log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: barcode,
            status: 'failed',
            error_message: error.message,
            response_time: responseTime,
            chat_id: chatId,
            caption: caption,
            data_type: barcode.match(/^\d+$/) ? 'numeric' : 'mixed'
          })
        });

        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ${barcode}:`, error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©", "error");
        return false;
      }
    }

    // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function captureImage(barcode) {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (!barcode || barcode.trim() === '') {
          console.warn("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±ÙƒÙˆØ¯");
          return false;
        }

        if (!video.videoWidth || !video.videoHeight) {
          console.warn("âš ï¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©");
          showMessage("âš ï¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©", "warning");
          return false;
        }

        console.log("ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:", barcode.trim());

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        
        // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        ctx.drawImage(video, 0, 0);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© Ù„ÙŠØ³Øª Ø³ÙˆØ¯Ø§Ø¡ Ø£Ùˆ ÙØ§Ø±ØºØ©
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let totalBrightness = 0;
        
        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø·ÙˆØ¹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
        for (let i = 0; i < data.length; i += 4) {
          totalBrightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
        }
        
        const averageBrightness = totalBrightness / (data.length / 4);
        
        if (averageBrightness < 10) {
          console.warn("âš ï¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¸Ù„Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ÙØ§Ø±ØºØ©");
          showMessage("âš ï¸ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¸Ù„Ù…Ø© Ø¬Ø¯Ø§Ù‹", "warning");
          return false;
        }

        // Ø¥Ø¶Ø§ÙØ© Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ù†Øµ
        ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        ctx.fillRect(10, 10, canvas.width - 20, 100);
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
        const now = new Date();
        const arabicDate = now.toLocaleString('ar-IQ', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZone: 'Asia/Baghdad'
        });
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Øµ
        ctx.font = "bold 18px Cairo";
        ctx.fillStyle = "#00ff88";
        ctx.textAlign = "right";
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø¹Ø±Ø¶
        let displayBarcode = barcode.trim();
        if (displayBarcode.startsWith("00")) {
          displayBarcode = displayBarcode.substring(2);
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ - Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù†Ø¸ÙŠÙ ÙÙ‚Ø·
        ctx.fillText(displayBarcode, canvas.width - 20, 35);
        ctx.fillText(arabicDate, canvas.width - 20, 60);
        ctx.fillText("Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ±", canvas.width - 20, 85);
        
        // Ø¥Ø¶Ø§ÙØ© Ø¥Ø·Ø§Ø± Ø²Ø®Ø±ÙÙŠ
        ctx.strokeStyle = "#00ff88";
        ctx.lineWidth = 3;
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØ±Ø© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø©
        const imageDataUrl = canvas.toDataURL("image/jpeg", 0.9);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
        if (!imageDataUrl || imageDataUrl === 'data:,') {
          console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø©");
          showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©", "error");
          return false;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ù‚ÙŠÙˆØ¯ Ù…Ø­Ø³Ù†Ø© ÙˆÙ…ØªÙˆØ§ÙÙ‚Ø©
        const sizeInBytes = Math.round((imageDataUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
        const sizeInKB = sizeInBytes / 1024;
        console.log("ğŸ“Š Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©:", sizeInKB.toFixed(2) + " KB");
        
        // Ù‚ÙŠÙˆØ¯ Ù…Ø­Ø³Ù†Ø© ÙˆÙ…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ sendToTelegram
        if (sizeInBytes < 512) { // 512 Ø¨Ø§ÙŠØª ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ sendToTelegram)
          console.warn("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹");
          showMessage("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ØµØºÙŠØ± Ø¬Ø¯Ø§Ù‹ - Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¹ Ø¬ÙˆØ¯Ø© Ø£Ø¹Ù„Ù‰", "warning");
          
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†ØªØ§Ø¬ ØµÙˆØ±Ø© Ø¨Ø¬ÙˆØ¯Ø© Ø£Ø¹Ù„Ù‰
          const higherQualityUrl = canvas.toDataURL("image/jpeg", 0.95);
          const newSize = Math.round((higherQualityUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
          
          if (newSize >= 512) {
            console.log("âœ… ØªÙ… ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰:", (newSize / 1024).toFixed(2) + " KB");
            return sendToTelegram(barcode, higherQualityUrl, barcode);
          } else {
            showMessage("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©", "warning");
            return false;
          }
        }
        
        if (sizeInBytes > 20 * 1024 * 1024) { // 20MB ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ sendToTelegram)
          console.warn("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹");
          showMessage("âš ï¸ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ - Ø³ÙŠØªÙ… Ø¶ØºØ·Ù‡Ø§", "warning");
          
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
          const compressedUrl = canvas.toDataURL("image/jpeg", 0.7);
          const compressedSize = Math.round((compressedUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
          
          
          if (compressedSize <= 20 * 1024 * 1024) {
            console.log("âœ… ØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰:", (compressedSize / 1024).toFixed(2) + " KB");
            return sendToTelegram(barcode, compressedUrl, barcode);
          } else {
            showMessage("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù…Ø§ ÙÙŠÙ‡ Ø§Ù„ÙƒÙØ§ÙŠØ©", "warning");
            return false;
          }
        }
        
        console.log("âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­");
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        const sendResult = sendToTelegram(barcode, imageDataUrl, barcode);
        return sendResult;
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©", "error");
        return false;
      }
    }

    // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø­ÙˆÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function drawFrame(location, color, text) {
    const { topLeftCorner, topRightCorner, bottomRightCorner, bottomLeftCorner } = location;
      
      context.strokeStyle = color;
      context.lineWidth = 4;
    context.beginPath();
    context.moveTo(topLeftCorner.x, topLeftCorner.y);
    context.lineTo(topRightCorner.x, topRightCorner.y);
    context.lineTo(bottomRightCorner.x, bottomRightCorner.y);
    context.lineTo(bottomLeftCorner.x, bottomLeftCorner.y);
    context.closePath();
    context.stroke();

      // Ø§Ù„Ù†Øµ
    context.fillStyle = color;
      context.font = "bold 16px Cairo";
      context.fillText(text, topLeftCorner.x, topLeftCorner.y - 10);
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØªØ´Ù Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function handleBarcode(code) {
      try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        if (!code || !code.data) {
          console.warn("âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø±ØºØ©");
          return false;
        }

        const barcode = code.data.trim();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„ÙŠØ³ ÙØ§Ø±ØºØ§Ù‹
        if (!barcode || barcode === '') {
          console.warn("âš ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø±Øº Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ");
          showMessage("âš ï¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­", "warning");
          return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ù‚ØµÙŠØ±Ø©)
        if (barcode.length < 1) {
          console.warn("âš ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø±Øº:", barcode);
          showMessage("âš ï¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙØ§Ø±Øº", "warning");
          return false;
        }

        if (barcode.length > 100) {
          console.warn("âš ï¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹:", barcode);
          showMessage("âš ï¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹", "warning");
          return false;
        }

        console.log("ğŸ” Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø§Ø±ÙƒÙˆØ¯ ØµØ­ÙŠØ­:", barcode, "Ø·ÙˆÙ„:", barcode.length);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const isNumeric = /^\d+$/.test(barcode);
        const barcodeInfo = {
          data: barcode,
          length: barcode.length,
          type: isNumeric ? "Ø±Ù‚Ù…ÙŠ" : "Ù†ØµÙŠ/Ù…Ø®ØªÙ„Ø·",
          originalCode: code
        };
        
        console.log("ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:", barcodeInfo);
        
    const now = Date.now();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©
        if (barcodeDatabase.has(barcode)) {
          const timeDiff = (now - barcodeTimes[barcode]) / 1000;
          
          if (timeDiff < 20) {
            // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø± Ø­Ø¯ÙŠØ« - Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
            drawFrame(code.location, "#ffa726", `â±ï¸ ${Math.ceil(20 - timeDiff)}s`);
            console.log(`â³ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø­Ø¯ÙŠØ«ØŒ Ø§Ù†ØªØ¸Ø§Ø± ${Math.ceil(20 - timeDiff)} Ø«Ø§Ù†ÙŠØ©`);
          } else {
            // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø± Ù‚Ø¯ÙŠÙ…
            drawFrame(code.location, "#ff6b6b", "âŒ Ù…ÙƒØ±Ø±");
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (!repeatedBarcodes.has(barcode)) {
              repeatedBarcodes.add(barcode);
              console.log("ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª:", barcode);
            }
            
            showMessage(`âš ï¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø±: ${barcode}`, "warning");
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±
            showDuplicateBarcodeImage(barcode);
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±
            showDuplicateBarcodeImage(barcode);
          }
        } else {
          // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
          console.log("âœ… Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯:", barcode);
          
          // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          barcodeDatabase.add(barcode);
          barcodeTimes[barcode] = now;
          
          // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          if (!newBarcodes.includes(barcode)) {
            newBarcodes.push(barcode);
          }
          
          // Ø±Ø³Ù… Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø®Ø¶Ø±
          drawFrame(code.location, "#00ff88", "âœ… Ø¬Ø¯ÙŠØ¯");
          
          // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          let displayBarcode = barcode;
          if (barcode.startsWith("00")) {
            displayBarcode = barcode.substring(2);
          }
          
          const barcodeType = code.barcodeType || "Ø¨Ø§Ø±ÙƒÙˆØ¯";
          const dataType = isNumeric ? "Ø±Ù‚Ù…ÙŠ" : "Ù…Ø®ØªÙ„Ø·";
          showMessage(`âœ… ${barcodeType} ${dataType} Ø¬Ø¯ÙŠØ¯: ${displayBarcode} (${barcode.length} Ø±Ù‚Ù…/Ø­Ø±Ù)`, "success");
          
          // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
          if (beepSound) {
            beepSound.play().catch(error => {
              console.log("ğŸ”‡ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", error.message);
            });
          }
          
          // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†) Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©
          saveToServer(barcode).then(saveResult => {
            if (saveResult.success) {
              if (saveResult.isDuplicate) {
                console.log("ğŸ”„ ØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø±:", saveResult.duplicateInfo);
                
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (!repeatedBarcodes.has(barcode)) {
                  repeatedBarcodes.add(barcode);
                  updateLists();
                  saveLocalData();
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                showMessage(`ğŸ”„ ØªÙ… Ø­ÙØ¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø± ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… (Ø§Ù„Ù…Ø±Ø© Ø±Ù‚Ù… ${saveResult.duplicateInfo.scan_number})`, "warning");
              } else {
                console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…");
              }
            } else {
              console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…");
            }
          }).catch(error => {
            console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
          });
          
          // Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†)
          setTimeout(() => {
            captureImageAndQueue(barcode, 'high'); // Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          }, 100);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        updateLists();
        saveLocalData();
        
        return true;
        
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯", "error");
        return false;
      }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    function scanBarcode() {
      if (!isScanning) return;
      
      if (!video.videoWidth || !video.videoHeight) {
        requestAnimationFrame(scanBarcode);
        return;
      }

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    context.clearRect(0, 0, overlay.width, overlay.height);

      try {
        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ù†ÙØ§Ø³ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø³Ø­
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        
        // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† QR Code Ø£ÙˆÙ„Ø§Ù‹ Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
        let code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth",
          allowFloatingPoint: true,
          minScore: 0.3
        });

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ QRØŒ Ø¬Ø±Ø¨ Ù…Ø¹ Ø¯Ù‚Ø© Ø£Ù‚Ù„ Ù„Ù„Ø³Ø±Ø¹Ø©
        if (!code) {
          const smallCanvas = document.createElement("canvas");
          const scale = 0.5;
          smallCanvas.width = canvas.width * scale;
          smallCanvas.height = canvas.height * scale;
          const smallCtx = smallCanvas.getContext("2d");
          smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
          
          const smallImageData = smallCtx.getImageData(0, 0, smallCanvas.width, smallCanvas.height);
          code = jsQR(smallImageData.data, smallImageData.width, smallImageData.height, {
            inversionAttempts: "attemptBoth"
          });
        }

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ QRØŒ Ø¬Ø±Ø¨ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©
        if (!code) {
          const enhancedData = enhanceImageForScanning(imageData);
          code = jsQR(enhancedData.data, enhancedData.width, enhancedData.height, {
            inversionAttempts: "attemptBoth"
          });
        }

        // Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ QR CodeØŒ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹
        if (code && code.data && code.data.trim() !== '') {
          console.log("ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ QR Code:", code.data);
          code.barcodeType = "QR Code";
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹
          checkDuplicateAndHandle(code);
      } else {
          // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ QR Code
          scanRegularBarcode(canvas).then(regularCode => {
            if (regularCode && regularCode.data && regularCode.data.trim() !== '') {
              console.log("ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ:", regularCode.data);
              regularCode.barcodeType = "Barcode";
              handleBarcode(regularCode);
            }
          }).catch(error => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ:", error);
          });
        }

        // Ø±Ø³Ù… Ø®Ø· Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„Ø¥Ø·Ø§Ø±Ø§Øª
        drawScannerFrame();

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­:", error);
    }

    requestAnimationFrame(scanBarcode);
  }

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø³Ø­
    function enhanceImageForScanning(imageData) {
      const data = imageData.data;
      const enhancedData = new Uint8ClampedArray(data.length);
      
      for (let i = 0; i < data.length; i += 4) {
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø±Ù…Ø§Ø¯ÙŠ
        const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
        
        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ†
        const enhanced = gray > 128 ? 255 : 0;
        
        enhancedData[i] = enhanced;     // R
        enhancedData[i + 1] = enhanced; // G
        enhancedData[i + 2] = enhanced; // B
        enhancedData[i + 3] = 255;      // A
      }
      
      return new ImageData(enhancedData, imageData.width, imageData.height);
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Code128, Code39, EAN, UPC, Ø¥Ù„Ø®)
    function scanRegularBarcode(canvas) {
      try {
        if (!window.Quagga) {
          console.warn("Ù…ÙƒØªØ¨Ø© QuaggaJS ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©");
          return null;
        }

        return new Promise((resolve) => {
          // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ù†ÙØ§Ø³ Ù…Ø¤Ù‚Øª Ø£ØµØºØ± Ù„Ù„Ø³Ø±Ø¹Ø©
          const tempCanvas = document.createElement('canvas');
          const scale = 0.7;
          tempCanvas.width = canvas.width * scale;
          tempCanvas.height = canvas.height * scale;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);

          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¥Ù„Ù‰ URL
          const imageUrl = tempCanvas.toDataURL('image/jpeg', 0.7);

          // ØªÙƒÙˆÙŠÙ† Quagga Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          Quagga.decodeSingle({
            decoder: {
              readers: [
                "code_128_reader",
                "ean_reader", 
                "ean_8_reader",
                "code_39_reader",
                "code_39_vin_reader",
                "codabar_reader",
                "upc_reader",
                "upc_e_reader",
                "i2of5_reader"
              ]
            },
            locate: true,
            src: imageUrl
          }, function(result) {
            if (result && result.codeResult && result.codeResult.code) {
              console.log("ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ø§Ø¯ÙŠ:", result.codeResult.code);
              
              // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù€ jsQR
              const fakeLocation = {
                topLeftCorner: { x: 50, y: 50 },
                topRightCorner: { x: canvas.width - 50, y: 50 },
                bottomRightCorner: { x: canvas.width - 50, y: canvas.height - 50 },
                bottomLeftCorner: { x: 50, y: canvas.height - 50 }
              };
              
              resolve({
                data: result.codeResult.code,
                location: fakeLocation
              });
    } else {
              resolve(null);
            }
          });

          // Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
          setTimeout(() => {
            resolve(null);
          }, 500);
        });

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ:", error);
        return null;
      }
    }

    // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø³Ù†
    function drawScannerFrame() {
      if (!context || !overlay.width || !overlay.height) return;
      
      try {
        // Ø±Ø³Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ù…ØªØ­Ø±Ùƒ ÙÙŠ Ø§Ù„ÙˆØ³Ø·
        const centerY = overlay.height / 2;
        const time = Date.now() * 0.003;
        const scanLineY = centerY + Math.sin(time) * 50;
        
        const gradient = context.createLinearGradient(0, scanLineY - 2, 0, scanLineY + 2);
        gradient.addColorStop(0, "transparent");
        gradient.addColorStop(0.5, "#00ff88");
        gradient.addColorStop(1, "transparent");
        
        context.fillStyle = gradient;
        context.fillRect(0, scanLineY - 1, overlay.width, 3);
        
        // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø³Ø­
        const centerX = overlay.width / 2;
        const frameSize = Math.min(overlay.width, overlay.height) * 0.6;
        const frameX = centerX - frameSize / 2;
        const frameY = centerY - frameSize / 2;
        
        const cornerSize = 30;
        const cornerWidth = 4;
        
        context.strokeStyle = "#00ff88";
        context.lineWidth = cornerWidth;
        context.setLineDash([]);
        
        // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
        context.beginPath();
        context.moveTo(frameX, frameY + cornerSize);
        context.lineTo(frameX, frameY);
        context.lineTo(frameX + cornerSize, frameY);
        context.stroke();
        
        // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰
        context.beginPath();
        context.moveTo(frameX + frameSize - cornerSize, frameY);
        context.lineTo(frameX + frameSize, frameY);
        context.lineTo(frameX + frameSize, frameY + cornerSize);
        context.stroke();
        
        // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
        context.beginPath();
        context.moveTo(frameX, frameY + frameSize - cornerSize);
        context.lineTo(frameX, frameY + frameSize);
        context.lineTo(frameX + cornerSize, frameY + frameSize);
        context.stroke();
        
        // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰
        context.beginPath();
        context.moveTo(frameX + frameSize - cornerSize, frameY + frameSize);
        context.lineTo(frameX + frameSize, frameY + frameSize);
        context.lineTo(frameX + frameSize, frameY + frameSize - cornerSize);
        context.stroke();
        
        // Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ø¥Ø±Ø´Ø§Ø¯ÙŠ
        context.font = "16px Cairo";
        context.fillStyle = "#ffffff";
        context.textAlign = "center";
        context.fillText("ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ QR Code", centerX, frameY + frameSize + 40);
        
        // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ±ÙƒÙŠØ²
        context.fillStyle = "#00ff88";
        const dotSize = 3;
        const dotPositions = [
          [frameX + frameSize/4, frameY + frameSize/4],
          [frameX + 3*frameSize/4, frameY + frameSize/4],
          [frameX + frameSize/4, frameY + 3*frameSize/4],
          [frameX + 3*frameSize/4, frameY + 3*frameSize/4]
        ];
        
        dotPositions.forEach(([x, y]) => {
          context.beginPath();
          context.arc(x, y, dotSize, 0, 2 * Math.PI);
          context.fill();
        });
        
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø±Ø³Ù… Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø³Ø­:", error);
      }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­ (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ø²Ø§Ø¦Ø¯Ø©)
    function startScanning() {
      if (isScanning) return;
      
      isScanning = true;
      console.log("ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­...");
      // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«
      scanBarcode();
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­
    function stopScanning() {
      isScanning = false;
      console.log("â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­");
      if (context) {
        context.clearRect(0, 0, overlay.width, overlay.height);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Ø¨ØµÙ…Øª)
    async function loadFromServer() {
      try {
        const response = await fetch("/get_barcodes");
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status}`);
        }
        
        const serverBarcodes = await response.json();
        if (!Array.isArray(serverBarcodes)) {
          throw new Error("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
        }
        
        serverBarcodes.forEach(([barcode, timestamp, dataType, length]) => {
          if (barcode && timestamp) {
            barcodeDatabase.add(barcode);
            barcodeTimes[barcode] = timestamp * 1000;
            if (!newBarcodes.includes(barcode)) {
              newBarcodes.push(barcode);
            }
          }
        });
        
        updateLists();
        saveLocalData();
        
        await loadDatabaseStats();
        await loadPeriodStats();
        
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        updateLists();
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨ØµÙ…Øª)
    async function loadDatabaseStats() {
      try {
        const response = await fetch("/stats");
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${response.status}`);
        }
        
        const stats = await response.json();
        if (!stats || typeof stats !== 'object') {
          throw new Error("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©");
        }
        
        displayDatabaseStats(stats);
        
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        
        databaseStats.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="color: #ff6b6b; margin-bottom: 10px;">
              âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </div>
            <div style="font-size: 0.9rem; opacity: 0.7;">
              ${error.message}
            </div>
            <button onclick="loadDatabaseStats()" class="btn info" style="margin-top: 15px;">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            </button>
          </div>
        `;
      }
    }

    // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function displayDatabaseStats(stats) {
      const typeBreakdown = stats.type_breakdown || {};
      const numericCount = typeBreakdown.numeric || 0;
      const mixedCount = typeBreakdown.mixed || 0;
      
      databaseStats.innerHTML = `
        <div class="db-stats">
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.total || 0}</div>
            <div class="db-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.today || 0}</div>
            <div class="db-stat-label">Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${numericCount}</div>
            <div class="db-stat-label">Ø±Ù‚Ù…ÙŠØ©</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${mixedCount}</div>
            <div class="db-stat-label">Ù…Ø®ØªÙ„Ø·Ø©</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.failed_frames || 0}</div>
            <div class="db-stat-label">Ø¥Ø·Ø§Ø±Ø§Øª ÙØ§Ø´Ù„Ø©</div>
          </div>
          <div class="db-stat-item">
            <div class="db-stat-number">${stats.database_size_kb || 0}</div>
            <div class="db-stat-label">KB Ø­Ø¬Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          </div>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
          <div style="font-size: 0.9rem; opacity: 0.8;">
            ${stats.last_barcode ? `Ø¢Ø®Ø± Ø¨Ø§Ø±ÙƒÙˆØ¯: ${stats.last_barcode}` : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø¨Ø¹Ø¯'}
          </div>
          <div style="font-size: 0.8rem; opacity: 0.6; margin-top: 5px;">
            ${stats.last_time ? `ÙÙŠ: ${new Date(stats.last_time * 1000).toLocaleString('ar-IQ', { timeZone: 'Asia/Baghdad' })}` : ''}
          </div>
        </div>
      `;
    }

    // Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
    async function resetDatabaseOnServer() {
      try {
        showMessage("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...", "success");
        
        const response = await fetch("/reset_database", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });
        
        if (response.ok) {
          console.log("âœ… ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…");
          return true;
        } else {
          const error = await response.text();
          console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
          return false;
        }
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…:", error);
        return false;
      }
    }

    // Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    function resetLocalDatabase() {
      barcodeDatabase.clear();
      barcodeTimes = {};
      repeatedBarcodes.clear();
      newBarcodes = [];
      
      // Ù…Ø³Ø­ localStorage
      localStorage.removeItem('barcodeData');
      
      console.log("âœ… ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©");
    }

    // Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ù…Ø­Ù„ÙŠ + Ø®Ø§Ø¯Ù…)
    async function resetCompleteDatabase() {
      try {
        // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        resetLocalDatabase();
        
        // Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        const serverResetSuccess = await resetDatabaseOnServer();
        
        if (serverResetSuccess) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
    updateLists();
          await loadDatabaseStats();
          
          showMessage("âœ… ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„", "success");
          return true;
        } else {
          showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…", "error");
          return false;
        }
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
        return false;
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØªØ·ÙˆØ± v2.0 âš¡
    async function initApp() {
      console.log("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ± v2.0 âš¡...");
      
      try {
        // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        loadLocalData();
        updateLists();
        loadFromServer();
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showMessage("âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§", "error");
          return;
        }
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        getCameras();
        await startCameraOptimized();
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ·ÙˆØ±
        startAdvancedScanningSystem();
        
        // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
        startQueueMonitoring();
        
        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
        setTimeout(() => {
          loadPeriodStats();
        }, 2000);
        
        console.log("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ·ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­! ğŸ¯");
        showMessage("ğŸ‰ Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ± v2.0 Ø¬Ø§Ù‡Ø²! âš¡", "success");
        
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: " + error.message, "error");
      }
    }
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    async function startCameraOptimized() {
      try {
        console.log("ğŸ“¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù†Ø©...");
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹
        const constraints = {
          video: {
            facingMode: currentCamera,
            width: { ideal: 1920, min: 640 },
            height: { ideal: 1080, min: 480 },
            frameRate: { ideal: 60, min: 30 }, // Ù…Ø¹Ø¯Ù„ Ø¥Ø·Ø§Ø±Ø§Øª Ø¹Ø§Ù„ÙŠ Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹
            focusMode: 'continuous',
            exposureMode: 'continuous',
            whiteBalanceMode: 'continuous'
          }
        };
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        currentStream = stream;
        
        return new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play();
            isScanning = true;
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø³Ù†
            scanBarcodeOptimized();
            
            console.log("âœ… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹");
            resolve();
          };
        });
        
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø­Ø³Ù†Ø©:", error);
        // fallback Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        startCamera();
      }
    }
    
    // Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø³Ù† ÙˆØ§Ù„Ø³Ø±ÙŠØ¹
    function scanBarcodeOptimized() {
      if (!isScanning) return;
      
      if (!video.videoWidth || !video.videoHeight) {
        requestAnimationFrame(scanBarcodeOptimized);
        return;
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      context.clearRect(0, 0, overlay.width, overlay.height);
      
      try {
        // Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ù…Ø³Ø­ Ù…ØªÙ‚Ø¯Ù…Ø© ÙˆÙ…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        let code = null;
        
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: Ù…Ø³Ø­ Ø³Ø±ÙŠØ¹ Ø¨Ø¯Ù‚Ø© ÙƒØ§Ù…Ù„Ø©
        code = performQuickScan();
        
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: Ù…Ø³Ø­ Ù…ØªÙˆØ³Ø· Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹
        if (!code) {
          code = performMediumScan();
        }
        
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3: Ù…Ø³Ø­ Ø¹Ù…ÙŠÙ‚ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù…ØªÙˆØ³Ø·
        if (!code) {
          code = performDeepScan();
        }
        
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4: Ù…Ø³Ø­ Ø§Ù„Ø¨ÙØ¹Ø¯ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø©
        if (!code && fastScanEnabled) {
          code = performDistanceScan();
        }
        
        // Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ Ø¨Ø§Ø±ÙƒÙˆØ¯ØŒ Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡
        if (code && code.data && code.data.trim() !== '') {
          console.log("ğŸ¯ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯:", code.data, "Ù†ÙˆØ¹:", code.barcodeType || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø©
          checkDuplicateAndHandle(code);
        }
        
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø³Ù†:", error);
      }
      
      // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ù…Ø³Ø­
      requestAnimationFrame(scanBarcodeOptimized);
    }
    
    // Ù…Ø³Ø­ Ø³Ø±ÙŠØ¹ - Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„ÙˆÙŠØ©
    function performQuickScan() {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // Ù…Ø³Ø­ QR Ø³Ø±ÙŠØ¹
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
          allowFloatingPoint: false,
          minScore: 0.5
        });
        
        if (code) {
          code.barcodeType = "QR Code (Ø³Ø±ÙŠØ¹)";
          return code;
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // Ù…Ø³Ø­ Ù…ØªÙˆØ³Ø· - Ø¯Ù‚Ø© Ù…ØªÙˆØ§Ø²Ù†Ø©
    function performMediumScan() {
      try {
        const canvas = document.createElement("canvas");
        const scale = 0.7; // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø³Ø±Ø¹Ø©
        canvas.width = video.videoWidth * scale;
        canvas.height = video.videoHeight * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "attemptBoth",
          allowFloatingPoint: true,
          minScore: 0.3
        });
        
        if (code) {
          code.barcodeType = "QR Code (Ù…ØªÙˆØ³Ø·)";
          return code;
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // Ù…Ø³Ø­ Ø¹Ù…ÙŠÙ‚ - Ø£Ø¹Ù„Ù‰ Ø¯Ù‚Ø©
    function performDeepScan() {
      try {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…ÙŠÙ‚
        const enhancedData = enhanceImageForDeepScanning(imageData);
        
        const code = jsQR(enhancedData.data, enhancedData.width, enhancedData.height, {
          inversionAttempts: "attemptBoth",
          allowFloatingPoint: true,
          minScore: 0.1
        });
        
        if (code) {
          code.barcodeType = "QR Code (Ø¹Ù…ÙŠÙ‚)";
          return code;
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙØ¹Ø¯ - Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø©
    function performDistanceScan() {
      try {
        // Ù…Ø³Ø­ Ù…Ù†Ø§Ø·Ù‚ Ù…ØªØ¹Ø¯Ø¯Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
        const regions = [
          { x: 0, y: 0, w: 0.5, h: 0.5 },           // Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø±
          { x: 0.5, y: 0, w: 0.5, h: 0.5 },         // Ø£Ø¹Ù„Ù‰ ÙŠÙ…ÙŠÙ†
          { x: 0, y: 0.5, w: 0.5, h: 0.5 },         // Ø£Ø³ÙÙ„ ÙŠØ³Ø§Ø±
          { x: 0.5, y: 0.5, w: 0.5, h: 0.5 },       // Ø£Ø³ÙÙ„ ÙŠÙ…ÙŠÙ†
          { x: 0.25, y: 0.25, w: 0.5, h: 0.5 }      // Ø§Ù„Ù…Ø±ÙƒØ²
        ];
        
        for (const region of regions) {
          const canvas = document.createElement("canvas");
          const regionWidth = video.videoWidth * region.w;
          const regionHeight = video.videoHeight * region.h;
          canvas.width = regionWidth;
          canvas.height = regionHeight;
          const ctx = canvas.getContext("2d");
          
          // Ù…Ø³Ø­ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          ctx.drawImage(
            video,
            video.videoWidth * region.x, video.videoHeight * region.y, regionWidth, regionHeight,
            0, 0, regionWidth, regionHeight
          );
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "attemptBoth",
            minScore: 0.2
          });
          
          if (code) {
            code.barcodeType = "QR Code (Ø¨ÙØ¹Ø¯)";
            return code;
          }
        }
        
        return null;
      } catch (error) {
        return null;
      }
    }
    
    // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…ÙŠÙ‚
    function enhanceImageForDeepScanning(imageData) {
      const data = new Uint8ClampedArray(imageData.data);
      
      // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ† ÙˆØ§Ù„Ø³Ø·ÙˆØ¹
      for (let i = 0; i < data.length; i += 4) {
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        
        // ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨Ø§ÙŠÙ†
        const enhanced = gray > 128 ? Math.min(255, gray * 1.2) : Math.max(0, gray * 0.8);
        
        data[i] = enhanced;     // R
        data[i + 1] = enhanced; // G
        data[i + 2] = enhanced; // B
        data[i + 3] = 255;      // A
      }
      
      return new ImageData(data, imageData.width, imageData.height);
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    function startAdvancedScanningSystem() {
      console.log("âš¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø³Ø­...");
      
      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹
      fastScanEnabled = true;
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø£Ø¯Ø§Ø¡
      addPerformanceIndicators();
      
      // ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      optimizeCameraResponse();
      
      console.log("âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¬Ø§Ù‡Ø²!");
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨ØµØ±ÙŠØ©
    function addPerformanceIndicators() {
      // Ù…Ø¤Ø´Ø± FPS
      let frameCount = 0;
      let lastTime = performance.now();
      
      setInterval(() => {
        const now = performance.now();
        const fps = Math.round(frameCount * 1000 / (now - lastTime));
        frameCount = 0;
        lastTime = now;
        
        // Ø¹Ø±Ø¶ FPS ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
        if (fps > 0) {
          console.log(`ğŸ“Š FPS: ${fps} | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø­: ${fastScanEnabled ? 'Ø³Ø±ÙŠØ¹' : 'Ø¹Ø§Ø¯ÙŠ'}`);
        }
      }, 1000);
      
      // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª
      const countFrames = () => {
        frameCount++;
        requestAnimationFrame(countFrames);
      };
      countFrames();
    }
    
    // ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    function optimizeCameraResponse() {
      // ØªØ­Ø³ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      if (video.srcObject) {
        const track = video.srcObject.getVideoTracks()[0];
        if (track && track.applyConstraints) {
          track.applyConstraints({
            focusMode: 'continuous',
            exposureMode: 'continuous',
            whiteBalanceMode: 'continuous'
          }).catch(error => {
            console.warn("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", error);
          });
        }
      }
    }
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
    function startQueueMonitoring() {
      console.log("ğŸ‘€ Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ø§Ø¨ÙˆØ± Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…...");
      
      // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
      queueUpdateInterval = setInterval(async () => {
        await updateQueueIndicator();
      }, 2000);
      
      // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ø£ÙˆÙ„ Ù…Ø±Ø©
      updateQueueIndicator();
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', initApp);

    // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„
    function addRestartButton() {
      const restartBtn = document.createElement('button');
      restartBtn.textContent = 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„';
      restartBtn.className = 'btn';
      restartBtn.onclick = () => {
        location.reload();
      };
      
      const controls = document.querySelector('.controls');
      if (controls && !document.querySelector('.restart-btn')) {
        restartBtn.classList.add('restart-btn');
        controls.appendChild(restartBtn);
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(addRestartButton, 2000);
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    window.addEventListener('beforeunload', () => {
      // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
    });

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø±Ø¤ÙŠØ© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log("ğŸ“± Ø§Ù„ØµÙØ­Ø© Ù…Ø®ÙÙŠØ© - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­ Ù…Ø¤Ù‚ØªØ§Ù‹");
        stopScanning();
      } else {
        console.log("ğŸ“± Ø§Ù„ØµÙØ­Ø© Ù…Ø±Ø¦ÙŠØ© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³Ø­");
        setTimeout(() => {
          if (!isScanning && currentStream) {
            startScanning();
          }
        }, 1000);
      }
    });

    // Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
    document.addEventListener('keydown', (event) => {
      switch(event.key) {
        case ' ':
          event.preventDefault();
          if (isScanning) {
            stopScanning();
          } else {
            startScanning();
          }
          break;
        case 'f':
        case 'F':
          event.preventDefault();
          flashToggle.click();
          break;
        case 'c':
        case 'C':
          event.preventDefault();
          cameraSwitch.click();
          break;
        case 'r':
        case 'R':
          event.preventDefault();
          initApp();
          break;
      }
    });

    // Ø¹Ø±Ø¶ Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    function showUsageTips() {
      // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    }

    // Ø¥Ø²Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    // setTimeout(showUsageTips, 5000);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø¨Ø¯ÙˆÙ† Ø±Ø³Ø§Ø¦Ù„ Ø²Ø§Ø¦Ø¯Ø©)
    refreshStatsBtn.addEventListener('click', async () => {
      try {
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        await loadFromServer();
        await loadDatabaseStats();
        await loadPeriodStats();
        // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "error");
      }
    });

    restartAppBtn.addEventListener('click', () => {
      // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
      setTimeout(() => {
        location.reload();
      }, 500);
    });

    viewDetailedStatsBtn.addEventListener('click', () => {
      statsModal.style.display = 'block';
      loadDetailedStats();
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©
    async function loadDetailedStats() {
      try {
        detailedStatsContent.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©...
          </div>
        `;

        const response = await fetch('/api/detailed-stats');
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
        }

        const stats = await response.json();
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©
        detailedStatsContent.innerHTML = `
          <div style="max-height: 500px; overflow-y: auto;">
            
            <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ù…</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold; color: #00ff88;">${stats.summary.total_barcodes}</div>
                  <div style="opacity: 0.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold; color: #ff6b6b;">${stats.summary.total_scans}</div>
                  <div style="opacity: 0.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø­Ø§Øª</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 2rem; font-weight: bold; color: #ffa726;">${stats.summary.avg_scans_per_barcode}</div>
                  <div style="opacity: 0.8;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø³Ø­Ø§Øª</div>
                </div>
              </div>
            </div>

            <!-- Ø£ÙƒØ«Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ù…Ø³Ø­Ø§Ù‹ -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ† Ø£ÙƒØ«Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª Ù…Ø³Ø­Ø§Ù‹</h3>
              ${stats.top_scanned.length > 0 ? 
                stats.top_scanned.map((item, index) => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div>
                      <span style="font-weight: bold;">#${index + 1}</span>
                      <span style="margin-right: 10px; font-family: monospace;">${item.barcode}</span>
                      <span style="font-size: 0.8rem; opacity: 0.7;">(${item.data_type})</span>
                    </div>
                    <div style="font-weight: bold; color: #00ff88;">${item.scan_count} Ù…Ø±Ø©</div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'
              }
            </div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ“‹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h3>
              ${stats.type_breakdown.length > 0 ? 
                stats.type_breakdown.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-weight: bold;">${item.type}</div>
                    <div>
                      <span style="color: #00ff88;">${item.unique_count} Ø¨Ø§Ø±ÙƒÙˆØ¯</span>
                      <span style="margin-right: 10px; color: #ffa726;">${item.total_scans} Ù…Ø³Ø­Ø©</span>
                    </div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'
              }
            </div>

            <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ“… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3>
              ${stats.daily_stats.length > 0 ? 
                stats.daily_stats.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div>${item.date}</div>
                    <div style="color: #00ff88; font-weight: bold;">${item.count} Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'
              }
            </div>

            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… -->
            ${stats.telegram_stats.length > 0 ? `
              <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ“± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…</h3>
                ${stats.telegram_stats.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-weight: bold;">${item.status === 'success' ? 'âœ… Ù†Ø§Ø¬Ø­' : item.status === 'failed' ? 'âŒ ÙØ§Ø´Ù„' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</div>
                    <div>
                      <span style="color: #00ff88;">${item.count} Ø±Ø³Ø§Ù„Ø©</span>
                      ${item.avg_response_time > 0 ? `<span style="margin-right: 10px; color: #ffa726;">${item.avg_response_time}ms</span>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            <!-- Ø£Ø­Ø¯Ø« Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª -->
            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ•’ Ø£Ø­Ø¯Ø« Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
              ${stats.recent_activities.length > 0 ? 
                stats.recent_activities.slice(0, 10).map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.9rem;">
                    <div>
                      <span style="font-family: monospace; font-weight: bold;">${item.barcode}</span>
                      <span style="margin-right: 8px; opacity: 0.7;">(${item.data_type})</span>
                    </div>
                    <div style="text-align: left;">
                      <div style="color: #00ff88;">${item.scan_count} Ù…Ø±Ø©</div>
                      <div style="font-size: 0.8rem; opacity: 0.6;">${item.last_scan}</div>
                    </div>
                  </div>
                `).join('') : 
                '<div style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª</div>'
              }
            </div>

            <!-- ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø·ÙˆØ§Ù„ -->
            ${stats.length_distribution.length > 0 ? `
              <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                <h3 style="margin-bottom: 15px; color: #4ecdc4;">ğŸ“ ØªÙˆØ²ÙŠØ¹ Ø£Ø·ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</h3>
                ${stats.length_distribution.map(item => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 3px 0; background: rgba(255,255,255,0.05); border-radius: 6px;">
                    <div>${item.length} Ø±Ù‚Ù…/Ø­Ø±Ù</div>
                    <div style="color: #00ff88; font-weight: bold;">${item.count} Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
                  </div>
                `).join('')}
              </div>
            ` : ''}

          </div>
        `;

        console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­");

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØµÙ„Ø©:", error);
        detailedStatsContent.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <div style="color: #ff6b6b; margin-bottom: 15px; font-size: 3rem;">âŒ</div>
            <div style="font-size: 1.2rem; margin-bottom: 10px;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
            <div style="opacity: 0.7; margin-bottom: 20px;">${error.message}</div>
            <button onclick="loadDetailedStats()" class="btn" style="background: linear-gradient(135deg, #4ecdc4, #44a08d); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            </button>
          </div>
        `;
      }
    }

    closeModal.addEventListener('click', () => {
      statsModal.style.display = 'none';
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
    window.addEventListener('click', (event) => {
      if (event.target === statsModal) {
        statsModal.style.display = 'none';
      }
    });

    // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    async function loadPeriodStats() {
      console.log("ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
      
      try {
        // Ø¹Ø±Ø¶ loading Ø£ÙˆÙ„Ø§Ù‹
        periodStats.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...
          </div>
        `;

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API
        const response = await fetch('/api/detailed-stats');
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
        }

        const data = await response.json();
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        const now = new Date();
        const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
        const lastWeekData = Array.from({length: 7}, (_, i) => {
          const date = new Date(now);
          date.setDate(date.getDate() - (i + 7));
          return data.daily_stats.find(d => d.date === date.toISOString().split('T')[0])?.count || 0;
        });
        const lastWeek = lastWeekData.reduce((sum, count) => sum + count, 0);
        
        const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisMonth = data.daily_stats.filter(day => {
          const dayDate = new Date(day.date);
          return dayDate >= thisMonthStart;
        }).reduce((sum, day) => sum + day.count, 0);

        // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ
        const weekGrowth = lastWeek > 0 ? ((thisWeek - lastWeek) / lastWeek * 100).toFixed(1) : '0';
        const weekGrowthIcon = weekGrowth > 0 ? 'ğŸ“ˆ' : weekGrowth < 0 ? 'ğŸ“‰' : 'â–';
        const weekGrowthColor = weekGrowth > 0 ? '#00ff88' : weekGrowth < 0 ? '#ff6b6b' : '#ffa726';

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        periodStats.innerHTML = `
          <div class="db-stats">
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
              <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
            </div>
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: #ff6b6b;">${lastWeek}</div>
              <div class="db-stat-label">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ</div>
            </div>
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
              <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
            </div>
            <div class="db-stat-item" style="cursor: pointer; transition: all 0.3s ease;" 
                 onmouseover="this.style.transform='scale(1.05)'" 
                 onmouseout="this.style.transform='scale(1)'">
              <div class="db-stat-number" style="color: ${weekGrowthColor};">${weekGrowth}%</div>
              <div class="db-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ ${weekGrowthIcon}</div>
            </div>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
            <h4 style="margin-bottom: 15px; color: #4ecdc4; font-size: 1rem;">ğŸ“Š Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h4>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 15px;">
              ${data.daily_stats.slice(-7).map((day, index) => {
                const dayName = new Date(day.date).toLocaleDateString('ar-SA', { weekday: 'short' });
                const isToday = day.date === now.toISOString().split('T')[0];
                const height = Math.max(10, (day.count / Math.max(...data.daily_stats.map(d => d.count)) * 40));
                return `
                  <div style="text-align: center;">
                    <div style="height: 50px; display: flex; align-items: end; justify-content: center;">
                      <div style="
                        width: 20px; 
                        height: ${height}px; 
                        background: ${isToday ? 'linear-gradient(45deg, #ff6b6b, #4ecdc4)' : 'rgba(255,255,255,0.3)'}; 
                        border-radius: 2px 2px 0 0;
                        ${isToday ? 'box-shadow: 0 0 10px rgba(255,107,107,0.5);' : ''}
                        transition: all 0.3s ease;
                      " title="${day.count} Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ ${day.date}"></div>
                    </div>
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px; ${isToday ? 'font-weight: bold; color: #ff6b6b;' : ''}">${dayName}</div>
                    <div style="font-size: 0.8rem; font-weight: bold; color: #00ff88;">${day.count}</div>
                  </div>
                `;
              }).join('')}
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; opacity: 0.8;">
              <div>ğŸ’¡ Ø§Ù„Ù†Ù…Ùˆ: ${weekGrowth > 0 ? '+' : ''}${weekGrowth}% Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ</div>
              <div>ğŸ“… ${new Date().toLocaleDateString('ar-SA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
            </div>
          </div>
        `;

        console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");

      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©:", error);
        periodStats.innerHTML = `
          <div style="text-align: center; padding: 30px;">
            <div style="color: #ff6b6b; margin-bottom: 15px; font-size: 2rem;">âš ï¸</div>
            <div style="font-size: 1rem; margin-bottom: 10px;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
            <div style="opacity: 0.7; margin-bottom: 20px; font-size: 0.9rem;">${error.message}</div>
            <button onclick="loadPeriodStats()" class="btn info" style="padding: 8px 16px; font-size: 0.9rem;">
              ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            </button>
          </div>
        `;
      }
    }

    // ==================== Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ ====================
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    let fastScanEnabled = true;
    let queueUpdateInterval = null;
    let lastScannedBarcode = null;
    let scanCooldown = false;
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    async function checkDuplicateAndHandle(code) {
      if (!code || !code.data) return;
      
      const barcode = code.data.trim();
      
      // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
      if (lastScannedBarcode === barcode && scanCooldown) {
        console.log("â³ Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø§Ù„Ø³Ø±ÙŠØ¹");
        return;
      }
      
      try {
        console.log("âš¡ ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„Ù„ØªÙƒØ±Ø§Ø±:", barcode);
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹
        const response = await fetch(`/api/check-duplicate/${encodeURIComponent(barcode)}`);
        const duplicateInfo = await response.json();
        
        if (duplicateInfo.is_duplicate) {
          // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø± - Ø¹Ø±Ø¶ Ø¥Ø·Ø§Ø± Ø£Ø­Ù…Ø± ÙˆØ§Ù†Ø¨Ø«Ø§Ù‚
          console.log("ğŸš¨ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø± ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡:", barcode);
          
          drawFrame(code.location, "#ff0000", `âŒ Ù…ÙƒØ±Ø± (${duplicateInfo.scan_count}x)`);
          
          // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ÙˆÙ…ÙŠØ¶ Ù„Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø­Ù…Ø±
          setTimeout(() => {
            drawFrame(code.location, "#ff6666", `âš ï¸ ${duplicateInfo.time_ago}`);
          }, 500);
          
          // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ø°ÙŠØ±
          showMessage(`ğŸš¨ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙƒØ±Ø±: ${barcode} (ØªÙ… Ù…Ø³Ø­Ù‡ ${duplicateInfo.scan_count} Ù…Ø±Ø© - ${duplicateInfo.time_ago})`, "error");
          
          // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙˆØ±Ø§Ù‹
          showDuplicateBarcodeImage(barcode);
          
          // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… ÙƒÙ…ÙƒØ±Ø±
          saveToServer(barcode);
          
        } else {
          // Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø§Ø¯ÙŠØ© Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
          console.log("âœ¨ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡:", barcode);
          
          drawFrame(code.location, "#00ff00", "âœ… Ø¬Ø¯ÙŠØ¯");
          
          // ØªØ£Ø«ÙŠØ± Ù„Ù…Ø¹Ø§Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø®Ø¶Ø±
          setTimeout(() => {
            drawFrame(code.location, "#00ff88", "ğŸ¯ Ù…Ø¹Ø§Ù„Ø¬Ø©...");
          }, 300);
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø§Ø¯ÙŠØ©
          handleBarcode(code);
        }
        
        // ØªÙØ¹ÙŠÙ„ cooldown Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø±
        lastScannedBarcode = barcode;
        scanCooldown = true;
        setTimeout(() => {
          scanCooldown = false;
        }, 1000); // Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© cooldown
        
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹:", error);
        // fallback Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        handleBarcode(code);
      }
    }
    
    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© captureImage Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
    async function captureImageAndQueue(barcode, priority = 'normal') {
      try {
        console.log("ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø§Ø¨ÙˆØ±:", barcode, "Ø£ÙˆÙ„ÙˆÙŠØ©:", priority);
        
        if (!video.videoWidth || !video.videoHeight) {
          showMessage("âš ï¸ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©", "warning");
          return false;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø§Ù„Ù…Ø­Ø³Ù†
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        
        // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©
        ctx.drawImage(video, 0, 0);
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø²Ø®Ø§Ø±Ù
        const now = new Date();
        const arabicDate = now.toLocaleString('ar-IQ', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          timeZone: 'Asia/Baghdad'
        });
        
        // Ø®Ù„ÙÙŠØ© Ù„Ù„Ù†Øµ
        ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
        ctx.fillRect(10, 10, canvas.width - 20, 120);
        
        // Ø§Ù„Ù†ØµÙˆØµ - Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù†Ø¸ÙŠÙ ÙÙ‚Ø·
        ctx.font = "bold 20px Cairo";
        ctx.fillStyle = "#00ff88";
        ctx.textAlign = "right";
        
        let displayBarcode = barcode.trim();
        if (displayBarcode.startsWith("00")) {
          displayBarcode = displayBarcode.substring(2);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù†Ø¸ÙŠÙ ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
        ctx.fillText(displayBarcode, canvas.width - 20, 40);
        ctx.fillText(arabicDate, canvas.width - 20, 70);
        ctx.fillText("Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ·ÙˆØ± âš¡", canvas.width - 20, 100);
        
        // Ø¥Ø·Ø§Ø± Ø²Ø®Ø±ÙÙŠ Ù…ØªØ­Ø±Ùƒ
        ctx.strokeStyle = "#00ff88";
        ctx.lineWidth = 4;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
        const imageDataUrl = canvas.toDataURL("image/jpeg", 0.92);
        
        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø§Ø¨ÙˆØ±
        const queueResponse = await fetch('/api/telegram/queue-add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            barcode: barcode,
            image_data: imageDataUrl,
            priority: priority
          })
        });
        
        if (queueResponse.ok) {
          const queueResult = await queueResponse.json();
          console.log("ğŸ“¥ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø§Ø¨ÙˆØ±:", queueResult);
          
          showMessage(`ğŸ“¤ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø§Ø¨ÙˆØ± (Ù…ÙˆØ¶Ø¹ ${queueResult.queue_position})`, "success");
          updateQueueIndicator();
          
          return true;
        } else {
          showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø·Ø§Ø¨ÙˆØ±", "error");
          return false;
        }
        
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø·Ø§Ø¨ÙˆØ±:", error);
        showMessage("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©", "error");
        return false;
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø·Ø§Ø¨ÙˆØ±
    async function updateQueueIndicator() {
      try {
        const response = await fetch('/api/telegram/queue-status');
        const queueData = await response.json();
        
        const indicator = document.getElementById('telegram-queue-indicator');
        const countElement = document.getElementById('queue-count');
        const statusElement = document.getElementById('queue-status');
        const progressElement = document.getElementById('queue-progress');
        
        if (queueData.total_items > 0) {
          indicator.style.display = 'block';
          countElement.textContent = queueData.total_items;
          statusElement.textContent = queueData.is_processing ? 'ÙŠØ¹Ù…Ù„ ğŸ”„' : 'Ù…ØªÙˆÙ‚Ù â¸ï¸';
          statusElement.style.color = queueData.is_processing ? '#00ff88' : '#ffa726';
          
          // Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
          const progress = queueData.is_processing ? 100 : 0;
          progressElement.style.width = progress + '%';
          
        } else {
          indicator.style.display = 'none';
        }
        
      } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø·Ø§Ø¨ÙˆØ±:", error);
      }
    }
    
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±
    async function fetchBarcodeImage(barcode) {
      try {
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}`);
        
        const response = await fetch(`/api/barcode-image/${encodeURIComponent(barcode)}`);
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©: ${result.image_path}`);
            return result;
          } else {
            console.log(`â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}`);
            return null;
          }
        } else {
          console.log(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode} (${response.status})`);
          return null;
        }
      } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ${barcode}:`, error);
        return null;
      }
    }
    
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    async function showDuplicateBarcodeImage(barcode) {
      const modal = document.getElementById('duplicate-image-modal');
      const barcodeElement = document.getElementById('duplicate-barcode');
      const detailsElement = document.getElementById('duplicate-details');
      const imageContainer = document.getElementById('duplicate-image-container');
      
      if (!modal || !barcodeElement || !detailsElement || !imageContainer) {
        console.error("âŒ Ø¹Ù†Ø§ØµØ± modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        return;
      }
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      barcodeElement.textContent = barcode;
      detailsElement.textContent = "ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„";
      
      // Ø¹Ø±Ø¶ loading
      imageContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...
        </div>
      `;
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ù€ modal
      modal.style.display = 'block';
      
      // Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©
      const imageData = await fetchBarcodeImage(barcode);
      
      if (imageData) {
        imageContainer.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong>Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„:</strong> ${new Date(imageData.created_at).toLocaleString('ar-SA')}
          </div>
          <img src="${imageData.image_url}" 
               alt="ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ${barcode}" 
               style="
                 max-width: 100%; 
                 max-height: 400px; 
                 border-radius: 10px;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                 border: 2px solid #ffa726;
               "
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div style="display: none; color: #ff6b6b; text-align: center; padding: 20px;">
            âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
          </div>
        `;
        
        detailsElement.innerHTML = `
          <div style="margin-bottom: 10px;">
            ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹
          </div>
          <div style="font-size: 0.9rem; opacity: 0.8;">
            Ø§Ù„Ø­Ø§Ù„Ø©: <span style="color: ${imageData.status === 'success' ? '#00ff88' : '#ff6b6b'};">
              ${imageData.status === 'success' ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'}
            </span>
          </div>
        `;
      } else {
        imageContainer.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b6b;">
            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“·</div>
            <div style="margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©</div>
            <div style="font-size: 0.9rem; opacity: 0.7;">
              Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ… Ù…Ø³Ø­Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡
            </div>
          </div>
        `;
        
        detailsElement.textContent = "ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„ØŒ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©";
      }
    }
    
    // Event listeners Ù„Ù€ modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('duplicate-image-modal');
      const closeBtn = document.querySelector('.duplicate-close');
      const closeModalBtn = document.getElementById('close-duplicate-modal');
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ X
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      if (modal) {
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Escape
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });
    });
  </script>

  <!-- Ø¥ØµÙ„Ø§Ø­ ÙÙˆØ±ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© -->
  <script>
    // Ø¥Ø¶Ø§ÙØ© Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    document.addEventListener('DOMContentLoaded', () => {
      console.log("ğŸ”§ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
      
      // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement) {
          console.log("âœ… Ø¹Ù†ØµØ± period-stats Ù…ÙˆØ¬ÙˆØ¯");
          
          // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯Ø§Ù„Ø© ÙˆØ§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§
          if (typeof loadPeriodStats === 'function') {
            console.log("âœ… Ø¯Ø§Ù„Ø© loadPeriodStats Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§...");
            loadPeriodStats();
          } else {
            console.error("âŒ Ø¯Ø§Ù„Ø© loadPeriodStats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø©
            window.loadPeriodStats = async function() {
              try {
                periodStatsElement.innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...
                  </div>
                `;
                
                const response = await fetch('/api/detailed-stats');
                const data = await response.json();
                
                const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
                const thisMonth = data.daily_stats.filter(day => {
                  const dayDate = new Date(day.date);
                  const thisMonthStart = new Date();
                  thisMonthStart.setDate(1);
                  return dayDate >= thisMonthStart;
                }).reduce((sum, day) => sum + day.count, 0);
                
                periodStatsElement.innerHTML = `
                  <div class="db-stats">
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                      <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                      <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                      <div class="db-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                      <div class="db-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ ğŸ“Š</div>
                    </div>
                  </div>
                `;
                console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
              } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©:", error);
                periodStatsElement.innerHTML = `
                  <div style="text-align: center; padding: 30px;">
                    <div style="color: #ff6b6b;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                    <button onclick="loadPeriodStats()" class="btn info" style="margin-top: 10px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                  </div>
                `;
              }
            };
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
            loadPeriodStats();
          }
        } else {
          console.error("âŒ Ø¹Ù†ØµØ± period-stats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
      }, 3000);
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement && periodStatsElement.innerHTML.includes("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„")) {
          console.log("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
          if (typeof loadPeriodStats === 'function') {
            loadPeriodStats();
          }
        }
      }, 10000);
    });
  </script>

  <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage (Ø¨ØµÙ…Øª) -->
  <script>
    // Ø¥Ø¶Ø§ÙØ© Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    document.addEventListener('DOMContentLoaded', () => {
      console.log("ğŸ”§ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
      
      // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement) {
          console.log("âœ… Ø¹Ù†ØµØ± period-stats Ù…ÙˆØ¬ÙˆØ¯");
          
          // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯Ø§Ù„Ø© ÙˆØ§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§
          if (typeof loadPeriodStats === 'function') {
            console.log("âœ… Ø¯Ø§Ù„Ø© loadPeriodStats Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§...");
            loadPeriodStats();
          } else {
            console.error("âŒ Ø¯Ø§Ù„Ø© loadPeriodStats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø©
            window.loadPeriodStats = async function() {
              try {
                periodStatsElement.innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...
                  </div>
                `;
                
                const response = await fetch('/api/detailed-stats');
                const data = await response.json();
                
                const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
                const thisMonth = data.daily_stats.filter(day => {
                  const dayDate = new Date(day.date);
                  const thisMonthStart = new Date();
                  thisMonthStart.setDate(1);
                  return dayDate >= thisMonthStart;
                }).reduce((sum, day) => sum + day.count, 0);
                
                periodStatsElement.innerHTML = `
                  <div class="db-stats">
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                      <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                      <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                      <div class="db-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                      <div class="db-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ ğŸ“Š</div>
                    </div>
                  </div>
                `;
                console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
              } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©:", error);
                periodStatsElement.innerHTML = `
                  <div style="text-align: center; padding: 30px;">
                    <div style="color: #ff6b6b;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                    <button onclick="loadPeriodStats()" class="btn info" style="margin-top: 10px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                  </div>
                `;
              }
            };
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
            loadPeriodStats();
          }
        } else {
          console.error("âŒ Ø¹Ù†ØµØ± period-stats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
      }, 3000);
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement && periodStatsElement.innerHTML.includes("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„")) {
          console.log("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
          if (typeof loadPeriodStats === 'function') {
            loadPeriodStats();
          }
        }
      }, 10000);
    });
  </script>

  <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage (Ø¨ØµÙ…Øª) -->
  <script>
    // Ø¥Ø¶Ø§ÙØ© Ø¥ØµÙ„Ø§Ø­ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    document.addEventListener('DOMContentLoaded', () => {
      console.log("ğŸ”§ Ø¨Ø¯Ø¡ Ø¥ØµÙ„Ø§Ø­ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
      
      // Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement) {
          console.log("âœ… Ø¹Ù†ØµØ± period-stats Ù…ÙˆØ¬ÙˆØ¯");
          
          // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯Ø§Ù„Ø© ÙˆØ§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§
          if (typeof loadPeriodStats === 'function') {
            console.log("âœ… Ø¯Ø§Ù„Ø© loadPeriodStats Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§...");
            loadPeriodStats();
          } else {
            console.error("âŒ Ø¯Ø§Ù„Ø© loadPeriodStats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø©
            window.loadPeriodStats = async function() {
              try {
                periodStatsElement.innerHTML = `
                  <div class="loading">
                    <div class="spinner"></div>
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...
                  </div>
                `;
                
                const response = await fetch('/api/detailed-stats');
                const data = await response.json();
                
                const thisWeek = data.daily_stats.reduce((sum, day) => sum + day.count, 0);
                const thisMonth = data.daily_stats.filter(day => {
                  const dayDate = new Date(day.date);
                  const thisMonthStart = new Date();
                  thisMonthStart.setDate(1);
                  return dayDate >= thisMonthStart;
                }).reduce((sum, day) => sum + day.count, 0);
                
                periodStatsElement.innerHTML = `
                  <div class="db-stats">
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #00ff88;">${thisWeek}</div>
                      <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ffa726;">${thisMonth}</div>
                      <div class="db-stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #4ecdc4;">${data.summary.total_barcodes}</div>
                      <div class="db-stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª</div>
                    </div>
                    <div class="db-stat-item">
                      <div class="db-stat-number" style="color: #ff6b6b;">0%</div>
                      <div class="db-stat-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù…Ùˆ ğŸ“Š</div>
                    </div>
                  </div>
                `;
                console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
              } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©:", error);
                periodStatsElement.innerHTML = `
                  <div style="text-align: center; padding: 30px;">
                    <div style="color: #ff6b6b;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                    <button onclick="loadPeriodStats()" class="btn info" style="margin-top: 10px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                  </div>
                `;
              }
            };
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯ÙŠÙ„Ø©
            loadPeriodStats();
          }
        } else {
          console.error("âŒ Ø¹Ù†ØµØ± period-stats ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }
      }, 3000);
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
      setTimeout(() => {
        const periodStatsElement = document.getElementById("period-stats");
        if (periodStatsElement && periodStatsElement.innerHTML.includes("Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„")) {
          console.log("ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØªØ±Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ©...");
          if (typeof loadPeriodStats === 'function') {
            loadPeriodStats();
          }
        }
      }, 10000);
    });
  </script>

  <!-- Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© -->
  <script>
    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØ±Ø±
    async function fetchBarcodeImage(barcode) {
      try {
        console.log(`ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}`);
        
        const response = await fetch(`/api/barcode-image/${encodeURIComponent(barcode)}`);
        
        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©: ${result.image_path}`);
            return result;
          } else {
            console.log(`â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode}`);
            return null;
          }
        } else {
          console.log(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${barcode} (${response.status})`);
          return null;
        }
      } catch (error) {
        console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ${barcode}:`, error);
        return null;
      }
    }
    
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    async function showDuplicateBarcodeImage(barcode) {
      const modal = document.getElementById('duplicate-image-modal');
      const barcodeElement = document.getElementById('duplicate-barcode');
      const detailsElement = document.getElementById('duplicate-details');
      const imageContainer = document.getElementById('duplicate-image-container');
      
      if (!modal || !barcodeElement || !detailsElement || !imageContainer) {
        console.error("âŒ Ø¹Ù†Ø§ØµØ± modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
        return;
      }
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
      barcodeElement.textContent = barcode;
      detailsElement.textContent = "ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„";
      
      // Ø¹Ø±Ø¶ loading
      imageContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...
        </div>
      `;
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ù€ modal
      modal.style.display = 'block';
      
      // Ø¬Ù„Ø¨ Ø§Ù„ØµÙˆØ±Ø©
      const imageData = await fetchBarcodeImage(barcode);
      
      if (imageData) {
        imageContainer.innerHTML = `
          <div style="margin-bottom: 15px;">
            <strong>Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„:</strong> ${new Date(imageData.created_at).toLocaleString('ar-SA')}
          </div>
          <img src="${imageData.image_url}" 
               alt="ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ${barcode}" 
               style="
                 max-width: 100%; 
                 max-height: 400px; 
                 border-radius: 10px;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                 border: 2px solid #ffa726;
               "
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div style="display: none; color: #ff6b6b; text-align: center; padding: 20px;">
            âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
          </div>
        `;
        
        detailsElement.innerHTML = `
          <div style="margin-bottom: 10px;">
            ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø³Ø§Ø¨Ù‚Ø§Ù‹
          </div>
          <div style="font-size: 0.9rem; opacity: 0.8;">
            Ø§Ù„Ø­Ø§Ù„Ø©: <span style="color: ${imageData.status === 'success' ? '#00ff88' : '#ff6b6b'};">
              ${imageData.status === 'success' ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­' : 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'}
            </span>
          </div>
        `;
      } else {
        imageContainer.innerHTML = `
          <div style="text-align: center; padding: 30px; color: #ff6b6b;">
            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“·</div>
            <div style="margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©</div>
            <div style="font-size: 0.9rem; opacity: 0.7;">
              Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØªÙ… Ù…Ø³Ø­Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡
            </div>
          </div>
        `;
        
        detailsElement.textContent = "ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„ØŒ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…Ø­ÙÙˆØ¸Ø©";
      }
    }
    
    // Event listeners Ù„Ù€ modal Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø©
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('duplicate-image-modal');
      const closeBtn = document.querySelector('.duplicate-close');
      const closeModalBtn = document.getElementById('close-duplicate-modal');
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ X
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
          if (modal) modal.style.display = 'none';
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
      if (modal) {
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Escape
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
